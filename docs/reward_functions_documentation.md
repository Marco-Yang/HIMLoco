# HIMLoco å¥–åŠ±å‡½æ•°è®¾è®¡è¯¦ç»†æ–‡æ¡£

## ç›®å½•
- [æ¦‚è¿°](#æ¦‚è¿°)
- [å¥–åŠ±å‡½æ•°ç»“æ„å›¾](#å¥–åŠ±å‡½æ•°ç»“æ„å›¾)
- [å¥–åŠ±å‡½æ•°æ¶æ„](#å¥–åŠ±å‡½æ•°æ¶æ„)
- [å¥–åŠ±å‡½æ•°å®Œæ•´ä»£ç ä¸é€è¡Œè§£é‡Š](#å¥–åŠ±å‡½æ•°å®Œæ•´ä»£ç ä¸é€è¡Œè§£é‡Š)
- [é…ç½®å‚æ•°è¯´æ˜](#é…ç½®å‚æ•°è¯´æ˜)
- [å¥–åŠ±å‡½æ•°è®¡ç®—æµç¨‹è¯¦è§£](#å¥–åŠ±å‡½æ•°è®¡ç®—æµç¨‹è¯¦è§£)
- [è°ƒè¯•å’Œè°ƒä¼˜æŒ‡å—](#è°ƒè¯•å’Œè°ƒä¼˜æŒ‡å—)

---

## æ¦‚è¿°

HIMLoco é¡¹ç›®ä½¿ç”¨åŸºäºå¥–åŠ±å¡‘å½¢ï¼ˆReward Shapingï¼‰çš„å¼ºåŒ–å­¦ä¹ æ–¹æ³•æ¥è®­ç»ƒå››è¶³æœºå™¨äººçš„è¿åŠ¨æ§åˆ¶ç­–ç•¥ã€‚å¥–åŠ±å‡½æ•°è®¾è®¡æ˜¯è®­ç»ƒæˆåŠŸçš„å…³é”®ï¼Œå®ƒé€šè¿‡å¤šä¸ªå­å¥–åŠ±é¡¹çš„ç»„åˆæ¥å¼•å¯¼æœºå™¨äººå­¦ä¹ æœŸæœ›çš„è¡Œä¸ºã€‚

**æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š**
- ğŸ¯ å¤šç›®æ ‡ä¼˜åŒ–ï¼šç»“åˆé€Ÿåº¦è·Ÿè¸ªã€ç¨³å®šæ€§ã€èƒ½æ•ˆç­‰å¤šä¸ªç›®æ ‡
- âš™ï¸ å¯é…ç½®æ€§ï¼šæ¯ä¸ªå¥–åŠ±é¡¹éƒ½æœ‰ç‹¬ç«‹çš„æƒé‡ç³»æ•°ï¼ˆscaleï¼‰
- â±ï¸ æ—¶é—´æ­¥å½’ä¸€åŒ–ï¼šæ‰€æœ‰å¥–åŠ±æŒ‰æ—¶é—´æ­¥è¿›è¡Œç¼©æ”¾ï¼ˆä¹˜ä»¥ dtï¼‰
- ğŸ”„ æ¨¡å—åŒ–è®¾è®¡ï¼šæ¯ä¸ªå¥–åŠ±å‡½æ•°ç‹¬ç«‹å®ç°ï¼Œæ˜“äºæ‰©å±•å’Œä¿®æ”¹

**ä»£ç ä½ç½®ï¼š**
- å¥–åŠ±å‡½æ•°å®ç°ï¼š`legged_gym/envs/base/legged_robot.py` ï¼ˆç¬¬ 1111-1223 è¡Œï¼‰
- åŸºç¡€é…ç½®ï¼š`legged_gym/envs/base/legged_robot_config.py` ï¼ˆç¬¬ 162-180 è¡Œï¼‰
- å…·ä½“æœºå™¨äººé…ç½®ï¼š`legged_gym/envs/{robot_name}/{robot_name}_config.py`
- å¥–åŠ±è®¡ç®—é€»è¾‘ï¼š`legged_gym/envs/base/legged_robot.py` ï¼ˆç¬¬ 225-243 è¡Œï¼‰

---

## å¥–åŠ±å‡½æ•°ç»“æ„å›¾

### æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ€»å¥–åŠ±å‡½æ•° (Total Reward)                    â”‚
â”‚                    R_total = Î£(w_i Ã— r_i(s,a))                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡å¥–åŠ±      â”‚    â”‚ çº¦æŸæƒ©ç½š      â”‚    â”‚ æ­£åˆ™åŒ–æƒ©ç½š    â”‚
â”‚ (Task)       â”‚    â”‚ (Constraint) â”‚    â”‚ (Regularize) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â”‚                   â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€Ÿåº¦è·Ÿè¸ª       â”‚   â”‚ ç¨³å®šæ€§çº¦æŸ     â”‚   â”‚ åŠ¨ä½œå¹³æ»‘       â”‚
â”‚ â€¢ tracking_   â”‚   â”‚ â€¢ orientation â”‚   â”‚ â€¢ action_rate â”‚
â”‚   lin_vel     â”‚   â”‚ â€¢ lin_vel_z   â”‚   â”‚ â€¢ smoothness  â”‚
â”‚ â€¢ tracking_   â”‚   â”‚ â€¢ ang_vel_xy  â”‚   â”‚ â€¢ dof_acc     â”‚
â”‚   ang_vel     â”‚   â”‚ â€¢ base_height â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚               â”‚
                    â”‚ ç‰©ç†é™åˆ¶       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ â€¢ dof_pos_    â”‚   â”‚ èƒ½æ•ˆä¼˜åŒ–       â”‚
                    â”‚   limits      â”‚   â”‚ â€¢ torques     â”‚
                    â”‚ â€¢ dof_vel_    â”‚   â”‚ â€¢ dof_vel     â”‚
                    â”‚   limits      â”‚   â”‚ â€¢ joint_power â”‚
                    â”‚ â€¢ torque_     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚   limits      â”‚
                    â”‚ â€¢ collision   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚   â”‚ æ­¥æ€è´¨é‡       â”‚
                    â”‚ è¶³ç«¯çº¦æŸ       â”‚   â”‚ â€¢ foot_       â”‚
                    â”‚ â€¢ feet_stumbleâ”‚   â”‚   clearance   â”‚
                    â”‚ â€¢ feet_air_   â”‚   â”‚ â€¢ feet_air_   â”‚
                    â”‚   time        â”‚   â”‚   time        â”‚
                    â”‚ â€¢ feet_contactâ”‚   â”‚ â€¢ stand_still â”‚
                    â”‚   _forces     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¥–åŠ±å‡½æ•°åˆ†ç±»ä½“ç³»

```
å¥–åŠ±å‡½æ•° (22ä¸ª)
â”‚
â”œâ”€â”€ ğŸ“Š æ€§èƒ½ç›®æ ‡ (2ä¸ª) - æƒé‡: æ­£å€¼ï¼Œä¸»è¦é©±åŠ¨åŠ›
â”‚   â”œâ”€â”€ tracking_lin_vel      [+1.0]   çº¿æ€§é€Ÿåº¦è·Ÿè¸ª
â”‚   â””â”€â”€ tracking_ang_vel      [+0.5]   è§’é€Ÿåº¦è·Ÿè¸ª
â”‚
â”œâ”€â”€ ğŸ›¡ï¸ ç¨³å®šæ€§çº¦æŸ (4ä¸ª) - æƒé‡: è´Ÿå€¼ï¼Œä¿è¯ç¨³å®š
â”‚   â”œâ”€â”€ orientation          [-0.2]   å§¿æ€åå·®æƒ©ç½š
â”‚   â”œâ”€â”€ lin_vel_z            [-2.0]   å‚ç›´é€Ÿåº¦æƒ©ç½š
â”‚   â”œâ”€â”€ ang_vel_xy           [-0.05]  ä¿¯ä»°æ»šè½¬æƒ©ç½š
â”‚   â””â”€â”€ base_height          [-1.0]   èº«ä½“é«˜åº¦æƒ©ç½š
â”‚
â”œâ”€â”€ âš¡ èƒ½æ•ˆä¼˜åŒ– (3ä¸ª) - æƒé‡: è´Ÿå€¼ï¼Œé™ä½èƒ½è€—
â”‚   â”œâ”€â”€ torques              [-0.0]   åŠ›çŸ©æƒ©ç½š
â”‚   â”œâ”€â”€ dof_vel              [-0.0]   å…³èŠ‚é€Ÿåº¦æƒ©ç½š
â”‚   â””â”€â”€ joint_power          [-2e-5]  å…³èŠ‚åŠŸç‡æƒ©ç½š
â”‚
â”œâ”€â”€ ğŸ¨ åŠ¨ä½œè´¨é‡ (3ä¸ª) - æƒé‡: è´Ÿå€¼ï¼Œå¹³æ»‘æ§åˆ¶
â”‚   â”œâ”€â”€ action_rate          [-0.01]  åŠ¨ä½œå˜åŒ–ç‡æƒ©ç½š
â”‚   â”œâ”€â”€ smoothness           [-0.01]  äºŒé˜¶å¹³æ»‘åº¦æƒ©ç½š
â”‚   â””â”€â”€ dof_acc              [-2.5e-7] å…³èŠ‚åŠ é€Ÿåº¦æƒ©ç½š
â”‚
â”œâ”€â”€ ğŸ¦¶ è¶³ç«¯æ§åˆ¶ (4ä¸ª) - æƒé‡: æ··åˆï¼Œæ­¥æ€ä¼˜åŒ–
â”‚   â”œâ”€â”€ foot_clearance       [-0.01]  æ‘†åŠ¨ç›¸ç¦»åœ°é«˜åº¦
â”‚   â”œâ”€â”€ feet_air_time        [+0.0]   æ»ç©ºæ—¶é—´å¥–åŠ±
â”‚   â”œâ”€â”€ feet_stumble         [-0.0]   ç»Šå€’æƒ©ç½š
â”‚   â””â”€â”€ feet_contact_forces  [æœªé…ç½®]  æ¥è§¦åŠ›æƒ©ç½š
â”‚
â”œâ”€â”€ ğŸ”’ ç‰©ç†é™åˆ¶ (3ä¸ª) - æƒé‡: è´Ÿå€¼ï¼Œç¡¬ä»¶ä¿æŠ¤
â”‚   â”œâ”€â”€ dof_pos_limits       [0.0]    å…³èŠ‚ä½ç½®é™åˆ¶
â”‚   â”œâ”€â”€ dof_vel_limits       [0.0]    å…³èŠ‚é€Ÿåº¦é™åˆ¶
â”‚   â””â”€â”€ torque_limits        [0.0]    åŠ›çŸ©é™åˆ¶
â”‚
â”œâ”€â”€ âš ï¸ ç¢°æ’æ£€æµ‹ (2ä¸ª) - æƒé‡: è´Ÿå€¼ï¼Œé¿å…ç¢°æ’
â”‚   â”œâ”€â”€ collision            [-0.0]   èº«ä½“ç¢°æ’æ£€æµ‹
â”‚   â””â”€â”€ termination          [-0.0]   éæ­£å¸¸ç»ˆæ­¢æƒ©ç½š
â”‚
â””â”€â”€ ğŸ¯ ç‰¹æ®Šè¡Œä¸º (1ä¸ª) - æƒé‡: è´Ÿå€¼ï¼Œç‰¹å®šåœºæ™¯
    â””â”€â”€ stand_still          [-0.0]   é›¶å‘½ä»¤æ—¶é™æ­¢

æ³¨ï¼š[æ‹¬å·å†…] ä¸º Aliengo æœºå™¨äººçš„é»˜è®¤æƒé‡é…ç½®
```

### æƒé‡åˆ†å¸ƒå¯è§†åŒ–

```
æƒé‡å¤§å°åˆ†å¸ƒï¼ˆç»å¯¹å€¼ï¼Œå¯¹æ•°å°ºåº¦ï¼‰:

1.0    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ tracking_lin_vel
0.5    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ tracking_ang_vel
2.0    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ lin_vel_z
1.0    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ base_height
0.2    â–ˆâ–ˆâ–ˆâ–ˆ orientation
0.05   â–ˆ ang_vel_xy
0.01   â–Œ action_rate, smoothness, foot_clearance
2e-5   â– joint_power
2.5e-7 â– dof_acc
0.0    â– (ç¦ç”¨çš„å¥–åŠ±é¡¹)

å›¾ä¾‹: â–ˆ = 0.1 æƒé‡å•ä½
```

### å¥–åŠ±è®¡ç®—æ—¶é—´çº¿

```
æ—¶é—´æ­¥ t-2      æ—¶é—´æ­¥ t-1      æ—¶é—´æ­¥ t
    â”‚               â”‚               â”‚
    â”œâ”€ action[t-2]  â”œâ”€ action[t-1]  â”œâ”€ action[t] â—„â”€â”€ å½“å‰åŠ¨ä½œ
    â”œâ”€ state[t-2]   â”œâ”€ state[t-1]   â”œâ”€ state[t]  â—„â”€â”€ å½“å‰çŠ¶æ€
    â”‚               â”‚               â”‚
    â”‚               â”‚               â””â”€â–º è®¡ç®—å¥–åŠ±
    â”‚               â”‚                   â”‚
    â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ action_rate
    â”‚                                   â”‚ = (action[t] - action[t-1])Â²
    â”‚                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º smoothness
                                        â”‚ = (action[t] - 2Ã—action[t-1] + action[t-2])Â²
                                        â”‚
                                        â–¼
                                    Total Reward[t]
```

---

## å¥–åŠ±å‡½æ•°æ¶æ„

### æ ¸å¿ƒæ•°æ®ç»“æ„

```python
# åœ¨ LeggedRobot ç±»ä¸­çš„å…³é”®å±æ€§
class LeggedRobot(BaseTask):
    def __init__(self, cfg, sim_params, physics_engine, sim_device, headless):
        # å¥–åŠ±ç›¸å…³å±æ€§
        self.reward_scales: Dict[str, float]      # å¥–åŠ±æƒé‡å­—å…¸ {name: scale}
        self.reward_functions: List[callable]      # å¥–åŠ±å‡½æ•°åˆ—è¡¨
        self.reward_names: List[str]               # å¥–åŠ±å‡½æ•°åç§°åˆ—è¡¨
        self.episode_sums: Dict[str, Tensor]       # Episodeç´¯è®¡å¥–åŠ±
        self.rew_buf: Tensor                       # å½“å‰æ—¶é—´æ­¥æ€»å¥–åŠ± [num_envs]
```

### å¥–åŠ±è®¡ç®—æ ¸å¿ƒå‡½æ•°

#### 1. compute_reward() - è®¡ç®—æ€»å¥–åŠ±

**æºä»£ç ï¼š** `legged_gym/envs/base/legged_robot.py` (ç¬¬ 225-243 è¡Œ)

```python
def compute_reward(self):
    """ Compute rewards
        Calls each reward function which had a non-zero scale (processed in self._prepare_reward_function())
        adds each terms to the episode sums and to the total reward
    """
    # 1. åˆå§‹åŒ–å¥–åŠ±ç¼“å†²åŒºä¸º0
    self.rew_buf[:] = 0.
    
    # 2. éå†æ‰€æœ‰æ¿€æ´»çš„å¥–åŠ±å‡½æ•°
    for i in range(len(self.reward_functions)):
        name = self.reward_names[i]
        # 3. è°ƒç”¨å¥–åŠ±å‡½æ•°å¹¶ä¹˜ä»¥æƒé‡
        rew = self.reward_functions[i]() * self.reward_scales[name]
        # 4. ç´¯åŠ åˆ°æ€»å¥–åŠ±
        self.rew_buf += rew
        # 5. ç´¯åŠ åˆ°episodeç»Ÿè®¡
        self.episode_sums[name] += rew
    
    # 6. å¯é€‰ï¼šè£å‰ªè´Ÿå¥–åŠ±ä¸º0
    if self.cfg.rewards.only_positive_rewards:
        self.rew_buf[:] = torch.clip(self.rew_buf[:], min=0.)
    
    # 7. æ·»åŠ ç»ˆæ­¢å¥–åŠ±ï¼ˆåœ¨è£å‰ªä¹‹åï¼‰
    if "termination" in self.reward_scales:
        rew = self._reward_termination() * self.reward_scales["termination"]
        self.rew_buf += rew
        self.episode_sums["termination"] += rew
```

**é€è¡Œè§£é‡Šï¼š**

```python
self.rew_buf[:] = 0.
```
- å°†å¥–åŠ±ç¼“å†²åŒºé‡ç½®ä¸º0ï¼Œ`rew_buf` å½¢çŠ¶ä¸º `[num_envs]`
- æ¯ä¸ªç¯å¢ƒåœ¨æ¯ä¸ªæ—¶é—´æ­¥éƒ½ä¼šè®¡ç®—ç‹¬ç«‹çš„å¥–åŠ±

```python
for i in range(len(self.reward_functions)):
    name = self.reward_names[i]
```
- éå†æ‰€æœ‰æ¿€æ´»çš„å¥–åŠ±å‡½æ•°ï¼ˆæƒé‡éé›¶çš„å‡½æ•°ï¼‰
- `reward_names` å­˜å‚¨å‡½æ•°åç§°ï¼Œå¦‚ "tracking_lin_vel"

```python
rew = self.reward_functions[i]() * self.reward_scales[name]
```
- è°ƒç”¨å¥–åŠ±å‡½æ•°ï¼ˆè¿”å› `[num_envs]` å½¢çŠ¶çš„å¼ é‡ï¼‰
- ä¹˜ä»¥å¯¹åº”çš„æƒé‡ç³»æ•°ï¼ˆå·²ç»åœ¨åˆå§‹åŒ–æ—¶ä¹˜ä»¥äº† `dt`ï¼‰
- ä¾‹å¦‚ï¼š`_reward_tracking_lin_vel() * 0.005` (dt=0.005)

```python
self.rew_buf += rew
self.episode_sums[name] += rew
```
- å°†åŠ æƒåçš„å¥–åŠ±ç´¯åŠ åˆ°æ€»å¥–åŠ±ç¼“å†²åŒº
- åŒæ—¶ç´¯åŠ åˆ°episodeç»Ÿè®¡ä¸­ï¼Œç”¨äºæ—¥å¿—è®°å½•

```python
if self.cfg.rewards.only_positive_rewards:
    self.rew_buf[:] = torch.clip(self.rew_buf[:], min=0.)
```
- å¦‚æœé…ç½®å¯ç”¨ï¼Œå°†è´Ÿæ€»å¥–åŠ±è£å‰ªä¸º0
- é¿å…æ—©æœŸè®­ç»ƒä¸­çš„è¿‡åº¦æƒ©ç½šå¯¼è‡´è®­ç»ƒä¸ç¨³å®š

```python
if "termination" in self.reward_scales:
    rew = self._reward_termination() * self.reward_scales["termination"]
    self.rew_buf += rew
    self.episode_sums["termination"] += rew
```
- ç»ˆæ­¢å¥–åŠ±å•ç‹¬å¤„ç†ï¼Œåœ¨è£å‰ªä¹‹åæ·»åŠ 
- ç¡®ä¿å¤±è´¥æƒ©ç½šä¸ä¼šè¢« `only_positive_rewards` å½±å“

---

#### 2. _prepare_reward_function() - å‡†å¤‡å¥–åŠ±å‡½æ•°

**æºä»£ç ï¼š** `legged_gym/envs/base/legged_robot.py` (ç¬¬ 720-743 è¡Œ)

```python
def _prepare_reward_function(self):
    """ Prepares a list of reward functions, whcih will be called to compute the total reward.
        Looks for self._reward_<REWARD_NAME>, where <REWARD_NAME> are names of all non zero reward scales in the cfg.
    """
    # 1. ç§»é™¤æƒé‡ä¸º0çš„å¥–åŠ±é¡¹ï¼Œå¹¶å¯¹éé›¶æƒé‡ä¹˜ä»¥dt
    for key in list(self.reward_scales.keys()):
        scale = self.reward_scales[key]
        if scale==0:
            self.reward_scales.pop(key) 
        else:
            self.reward_scales[key] *= self.dt
    
    # 2. å‡†å¤‡å¥–åŠ±å‡½æ•°åˆ—è¡¨
    self.reward_functions = []
    self.reward_names = []
    for name, scale in self.reward_scales.items():
        if name=="termination":
            continue
        self.reward_names.append(name)
        name = '_reward_' + name
        self.reward_functions.append(getattr(self, name))

    # 3. åˆå§‹åŒ–episodeç´¯è®¡å¥–åŠ±å­—å…¸
    self.episode_sums = {name: torch.zeros(self.num_envs, dtype=torch.float, device=self.device, requires_grad=False)
                         for name in self.reward_scales.keys()}
```

**é€è¡Œè§£é‡Šï¼š**

```python
for key in list(self.reward_scales.keys()):
    scale = self.reward_scales[key]
```
- éå†é…ç½®ä¸­å®šä¹‰çš„æ‰€æœ‰å¥–åŠ±é¡¹
- `list()` åˆ›å»ºå‰¯æœ¬ï¼Œå› ä¸ºå¾ªç¯ä¸­ä¼šä¿®æ”¹å­—å…¸

```python
if scale==0:
    self.reward_scales.pop(key)
```
- ç§»é™¤æƒé‡ä¸º0çš„å¥–åŠ±é¡¹ï¼ˆç¦ç”¨çš„å¥–åŠ±ï¼‰
- å‡å°‘è®¡ç®—å¼€é”€ï¼Œæé«˜è®­ç»ƒæ•ˆç‡

```python
else:
    self.reward_scales[key] *= self.dt
```
- å¯¹éé›¶æƒé‡ä¹˜ä»¥æ—¶é—´æ­¥é•¿ `dt`ï¼ˆé€šå¸¸ä¸º 0.005 ç§’ï¼‰
- **æ—¶é—´å½’ä¸€åŒ–**ï¼šä½¿å¥–åŠ±å¤§å°ä¸æ§åˆ¶é¢‘ç‡æ— å…³
- ä¾‹å¦‚ï¼šæƒé‡ 1.0 â†’ 0.005ï¼Œè¿™æ ·æ¯ç§’çš„å¥–åŠ±æ€»é‡ä¿æŒä¸€è‡´

```python
self.reward_names.append(name)
name = '_reward_' + name
self.reward_functions.append(getattr(self, name))
```
- é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥æ‰¾åˆ°å¯¹åº”çš„å¥–åŠ±å‡½æ•°
- ä¾‹å¦‚ï¼š`"tracking_lin_vel"` â†’ `_reward_tracking_lin_vel`
- `getattr(self, name)` è·å–å‡½æ•°å¯¹è±¡å¹¶æ·»åŠ åˆ°åˆ—è¡¨
- è¿™ç§è®¾è®¡å…è®¸é€šè¿‡é…ç½®æ–‡ä»¶çµæ´»å¯ç”¨/ç¦ç”¨å¥–åŠ±é¡¹

```python
self.episode_sums = {name: torch.zeros(...) for name in self.reward_scales.keys()}
```
- ä¸ºæ¯ä¸ªå¥–åŠ±é¡¹åˆ›å»ºç´¯è®¡å¼ é‡ï¼Œå½¢çŠ¶ä¸º `[num_envs]`
- ç”¨äºè·Ÿè¸ªæ•´ä¸ªepisodeä¸­æ¯ä¸ªå¥–åŠ±é¡¹çš„æ€»å’Œ
- åœ¨episodeç»“æŸæ—¶ç”¨äºæ—¥å¿—è®°å½•å’Œåˆ†æ

---

#### 3. _parse_cfg() - è§£æé…ç½®

**æºä»£ç ï¼š** `legged_gym/envs/base/legged_robot.py` (ç¬¬ 920-927 è¡Œ)

```python
def _parse_cfg(self, cfg):
    self.dt = self.cfg.control.decimation * self.sim_params.dt
    self.obs_scales = self.cfg.normalization.obs_scales
    self.reward_scales = class_to_dict(self.cfg.rewards.scales)  # å°†é…ç½®ç±»è½¬æ¢ä¸ºå­—å…¸
    self.command_ranges = class_to_dict(self.cfg.commands.ranges)
    if self.cfg.terrain.mesh_type not in ['heightfield', 'trimesh']:
        self.cfg.terrain.curriculum = False
    self.max_episode_length_s = self.cfg.env.episode_length_s
    self.max_episode_length = np.ceil(self.max_episode_length_s / self.dt)
```

**å…³é”®ç‚¹ï¼š**
- `self.reward_scales` ä»é…ç½®ç±»ä¸­æå–ï¼Œè½¬æ¢ä¸ºå­—å…¸æ ¼å¼
- `dt` æ˜¯æ§åˆ¶æ—¶é—´æ­¥ï¼Œç­‰äºä»¿çœŸæ—¶é—´æ­¥ä¹˜ä»¥æŠ½å–å› å­
- ä¾‹å¦‚ï¼š`sim_dt=0.001`, `decimation=5` â†’ `dt=0.005`

---

### å¥–åŠ±å‡½æ•°è°ƒç”¨æµç¨‹å›¾

```
åˆå§‹åŒ–é˜¶æ®µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ __init__()                                                  â”‚
â”‚   â”‚                                                         â”‚
â”‚   â”œâ”€â–º _parse_cfg()                                         â”‚
â”‚   â”‚    â””â”€â–º self.reward_scales = class_to_dict(cfg.rewards) â”‚
â”‚   â”‚                                                         â”‚
â”‚   â”œâ”€â–º _prepare_reward_function()                           â”‚
â”‚   â”‚    â”œâ”€â–º ç§»é™¤æƒé‡ä¸º0çš„é¡¹                                  â”‚
â”‚   â”‚    â”œâ”€â–º æƒé‡ *= dt (æ—¶é—´å½’ä¸€åŒ–)                         â”‚
â”‚   â”‚    â”œâ”€â–º æ„å»º reward_functions åˆ—è¡¨                      â”‚
â”‚   â”‚    â””â”€â–º åˆå§‹åŒ– episode_sums                             â”‚
â”‚   â”‚                                                         â”‚
â”‚   â””â”€â–º å‡†å¤‡å®Œæˆ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿è¡Œé˜¶æ®µ (æ¯ä¸ªæ—¶é—´æ­¥):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ step(actions)                                               â”‚
â”‚   â”‚                                                         â”‚
â”‚   â”œâ”€â–º åº”ç”¨åŠ¨ä½œåˆ°ä»¿çœŸå™¨                                      â”‚
â”‚   â”œâ”€â–º æ›´æ–°çŠ¶æ€                                             â”‚
â”‚   â”‚                                                         â”‚
â”‚   â”œâ”€â–º compute_reward()                                     â”‚
â”‚   â”‚    â”‚                                                   â”‚
â”‚   â”‚    â”œâ”€â–º rew_buf[:] = 0                                 â”‚
â”‚   â”‚    â”‚                                                   â”‚
â”‚   â”‚    â”œâ”€â–º for each reward_function:                      â”‚
â”‚   â”‚    â”‚    â”œâ”€â–º rew = function() * scale                  â”‚
â”‚   â”‚    â”‚    â”œâ”€â–º rew_buf += rew                            â”‚
â”‚   â”‚    â”‚    â””â”€â–º episode_sums[name] += rew                 â”‚
â”‚   â”‚    â”‚                                                   â”‚
â”‚   â”‚    â”œâ”€â–º if only_positive_rewards:                      â”‚
â”‚   â”‚    â”‚    â””â”€â–º clip(rew_buf, min=0)                      â”‚
â”‚   â”‚    â”‚                                                   â”‚
â”‚   â”‚    â””â”€â–º æ·»åŠ  termination å¥–åŠ±                          â”‚
â”‚   â”‚                                                         â”‚
â”‚   â”œâ”€â–º compute_observations()                               â”‚
â”‚   â”œâ”€â–º check_termination()                                  â”‚
â”‚   â”‚                                                         â”‚
â”‚   â””â”€â–º return obs, rew_buf, done, info                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Episodeç»“æŸ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ reset_idx(env_ids)                                          â”‚
â”‚   â”‚                                                         â”‚
â”‚   â”œâ”€â–º è®°å½• episode ç»Ÿè®¡ä¿¡æ¯                                â”‚
â”‚   â”‚    â””â”€â–º for key in episode_sums:                        â”‚
â”‚   â”‚         extras["episode"]['rew_' + key] =              â”‚
â”‚   â”‚           mean(episode_sums[key]) / max_episode_length â”‚
â”‚   â”‚                                                         â”‚
â”‚   â”œâ”€â–º é‡ç½®ç¯å¢ƒçŠ¶æ€                                         â”‚
â”‚   â”‚                                                         â”‚
â”‚   â””â”€â–º episode_sums[env_ids] = 0  (é‡ç½®ç´¯è®¡å¥–åŠ±)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¥–åŠ±å‡½æ•°å®Œæ•´ä»£ç ä¸é€è¡Œè§£é‡Š

æœ¬ç« èŠ‚è¯¦ç»†ä»‹ç»æ¯ä¸ªå¥–åŠ±å‡½æ•°çš„å®Œæ•´æºä»£ç å’Œé€è¡Œè§£é‡Šã€‚æ‰€æœ‰ä»£ç å‡æ¥è‡ª `legged_gym/envs/base/legged_robot.py`ã€‚

---

### 1. tracking_lin_vel - çº¿æ€§é€Ÿåº¦è·Ÿè¸ªå¥–åŠ±

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1111-1114 è¡Œ

#### å®Œæ•´æºä»£ç ï¼ˆå¸¦è¯¦ç»†æ³¨é‡Šï¼‰

```python
def _reward_tracking_lin_vel(self):
    """
    è®¡ç®—çº¿æ€§é€Ÿåº¦è·Ÿè¸ªå¥–åŠ±
    
    ç›®æ ‡ï¼šé¼“åŠ±æœºå™¨äººçš„å®é™…é€Ÿåº¦æ¥è¿‘å‘½ä»¤é€Ÿåº¦ï¼ˆxå’Œyæ–¹å‘ï¼‰
    æ–¹æ³•ï¼šä½¿ç”¨é«˜æ–¯è¯¯å·®å‡½æ•°ï¼Œå°†é€Ÿåº¦è¯¯å·®æ˜ å°„åˆ°[0,1]åŒºé—´çš„å¥–åŠ±
    
    Returns:
        torch.Tensor: å½¢çŠ¶[num_envs]ï¼Œæ¯ä¸ªç¯å¢ƒçš„å¥–åŠ±å€¼ï¼ŒèŒƒå›´(0, 1]
    """
    # Tracking of linear velocity commands (xy axes)
    # è®¡ç®—çº¿æ€§é€Ÿåº¦è·Ÿè¸ªè¯¯å·®ï¼ˆä»…è€ƒè™‘xå’Œyæ–¹å‘ï¼Œå¿½ç•¥zæ–¹å‘ï¼‰
    lin_vel_error = torch.sum(torch.square(self.commands[:, :2] - self.base_lin_vel[:, :2]), dim=1)
    
    # ä½¿ç”¨é«˜æ–¯å‡½æ•°å°†è¯¯å·®è½¬æ¢ä¸ºå¥–åŠ±ï¼šè¯¯å·®ä¸º0æ—¶å¥–åŠ±æœ€å¤§(1.0)ï¼Œè¯¯å·®å¢å¤§æ—¶å¥–åŠ±æŒ‡æ•°è¡°å‡
    return torch.exp(-lin_vel_error/self.cfg.rewards.tracking_sigma)
```

#### é€è¡Œä»£ç è¯¦è§£

**ç¬¬1-9è¡Œï¼šå‡½æ•°å®šä¹‰å’Œæ–‡æ¡£å­—ç¬¦ä¸²**
```python
def _reward_tracking_lin_vel(self):
    """
    è®¡ç®—çº¿æ€§é€Ÿåº¦è·Ÿè¸ªå¥–åŠ±
    ...
    """
```
- **å‡½æ•°åç§°**: `_reward_tracking_lin_vel` (å‰ç¼€ä¸‹åˆ’çº¿è¡¨ç¤ºå†…éƒ¨å‡½æ•°)
- **è°ƒç”¨æ—¶æœº**: æ¯ä¸ªä»¿çœŸæ­¥éª¤(step)ï¼Œåœ¨`compute_reward()`ä¸­è¢«è°ƒç”¨
- **è¿”å›å€¼ç±»å‹**: `torch.Tensor`
- **è¿”å›å€¼å½¢çŠ¶**: `[num_envs]`ï¼Œä¾‹å¦‚4096ä¸ªå¹¶è¡Œç¯å¢ƒåˆ™ä¸º`[4096]`
- **è¿”å›å€¼èŒƒå›´**: (0, 1]ï¼Œæ³¨æ„æ˜¯å·¦å¼€å³é—­åŒºé—´

**ç¬¬11-12è¡Œï¼šè®¡ç®—é€Ÿåº¦è¯¯å·®**
```python
lin_vel_error = torch.sum(torch.square(self.commands[:, :2] - self.base_lin_vel[:, :2]), dim=1)
```

**è¯¦ç»†æ‹†è§£**ï¼š
```python
# æ­¥éª¤1ï¼šæå–å‘½ä»¤é€Ÿåº¦çš„xå’Œyåˆ†é‡
# self.commands å½¢çŠ¶: [num_envs, 3]ï¼Œå…¶ä¸­[:, 0]æ˜¯vx, [:, 1]æ˜¯vy, [:, 2]æ˜¯yaw_rate
cmd_vel_xy = self.commands[:, :2]  # å½¢çŠ¶: [num_envs, 2]

# æ­¥éª¤2ï¼šæå–å®é™…é€Ÿåº¦çš„xå’Œyåˆ†é‡
# self.base_lin_vel æ˜¯æœºå™¨äººåŸºåº§åœ¨ä¸–ç•Œåæ ‡ç³»ä¸‹çš„çº¿é€Ÿåº¦
# é€šè¿‡é€†å››å…ƒæ•°æ—‹è½¬ä»ä¸–ç•Œåæ ‡è½¬æ¢åˆ°æœºå™¨äººæœ¬ä½“åæ ‡
actual_vel_xy = self.base_lin_vel[:, :2]  # å½¢çŠ¶: [num_envs, 2]

# æ­¥éª¤3ï¼šè®¡ç®—æ¯ä¸ªæ–¹å‘çš„è¯¯å·®
vel_diff = cmd_vel_xy - actual_vel_xy  # å½¢çŠ¶: [num_envs, 2]

# æ­¥éª¤4ï¼šè®¡ç®—å¹³æ–¹è¯¯å·®ï¼ˆL2èŒƒæ•°çš„å¹³æ–¹ï¼‰
squared_diff = torch.square(vel_diff)  # å½¢çŠ¶: [num_envs, 2]

# æ­¥éª¤5ï¼šå¯¹xå’Œyæ–¹å‘æ±‚å’Œï¼Œå¾—åˆ°æ€»è¯¯å·®
lin_vel_error = torch.sum(squared_diff, dim=1)  # å½¢çŠ¶: [num_envs]
```

**æ•°å­¦å…¬å¼**ï¼š
$$
E_{vel} = (v_x^{cmd} - v_x^{actual})^2 + (v_y^{cmd} - v_y^{actual})^2
$$

**ç¤ºä¾‹è®¡ç®—**ï¼š
```python
# å‡è®¾æŸä¸ªç¯å¢ƒï¼š
# å‘½ä»¤é€Ÿåº¦: vx=1.0 m/s, vy=0.2 m/s
# å®é™…é€Ÿåº¦: vx=0.9 m/s, vy=0.15 m/s

# è¯¯å·®è®¡ç®—:
error_x = (1.0 - 0.9)^2 = 0.01
error_y = (0.2 - 0.15)^2 = 0.0025
lin_vel_error = 0.01 + 0.0025 = 0.0125
```

**ç¬¬14è¡Œï¼šè®¡ç®—å¥–åŠ±å€¼**
```python
return torch.exp(-lin_vel_error/self.cfg.rewards.tracking_sigma)
```

**è¯¦ç»†æ‹†è§£**ï¼š
```python
# æ­¥éª¤1ï¼šå½’ä¸€åŒ–è¯¯å·®
# tracking_sigmaé»˜è®¤ä¸º0.25ï¼Œæ§åˆ¶é«˜æ–¯å‡½æ•°çš„å®½åº¦ï¼ˆå®¹å¿åº¦ï¼‰
normalized_error = lin_vel_error / self.cfg.rewards.tracking_sigma

# æ­¥éª¤2ï¼šåº”ç”¨é«˜æ–¯å‡½æ•°
# å°†è¯¯å·®æ˜ å°„åˆ°(0, 1]åŒºé—´ï¼Œè¯¯å·®è¶Šå°å¥–åŠ±è¶Šæ¥è¿‘1
reward = torch.exp(-normalized_error)
```

**æ•°å­¦å…¬å¼**ï¼š
$$
r = e^{-\frac{E_{vel}}{\sigma_{tracking}}}
$$

å…¶ä¸­ï¼š
- $E_{vel}$: é€Ÿåº¦è¯¯å·®çš„å¹³æ–¹å’Œ
- $\sigma_{tracking}$: è·Ÿè¸ªå®¹å¿åº¦å‚æ•°ï¼ˆé»˜è®¤0.25ï¼‰
- $r$: æœ€ç»ˆå¥–åŠ±å€¼

**ç¤ºä¾‹è®¡ç®—**ï¼ˆç»­ä¸Šä¾‹ï¼‰ï¼š
```python
# ä½¿ç”¨ä¸Šé¢è®¡ç®—çš„ lin_vel_error = 0.0125
# tracking_sigma = 0.25

normalized_error = 0.0125 / 0.25 = 0.05
reward = exp(-0.05) â‰ˆ 0.951

# è¿™æ„å‘³ç€é€Ÿåº¦è¯¯å·®å¾ˆå°æ—¶ï¼Œå¥–åŠ±æ¥è¿‘1.0
```

**å‚æ•°è¯´æ˜**ï¼š
- **`tracking_sigma = 0.25`** (é»˜è®¤å€¼)
  - æ§åˆ¶å¥–åŠ±å‡½æ•°çš„"å®½å®¹åº¦"
  - è¾ƒå°çš„sigmaï¼šå¯¹è¯¯å·®æ›´æ•æ„Ÿï¼Œå¥–åŠ±ä¸‹é™æ›´å¿«
  - è¾ƒå¤§çš„sigmaï¼šå¯¹è¯¯å·®æ›´å®½å®¹ï¼Œå¥–åŠ±ä¸‹é™è¾ƒæ…¢
  
**ä¸åŒsigmaå€¼çš„å½±å“**ï¼š
```python
# å‡è®¾é€Ÿåº¦è¯¯å·®ä¸º0.1 (m/s)Â²
# sigma=0.1:  reward = exp(-0.1/0.1) = exp(-1.0) â‰ˆ 0.368  (ä¸¥æ ¼)
# sigma=0.25: reward = exp(-0.1/0.25) = exp(-0.4) â‰ˆ 0.670  (ä¸­ç­‰)
# sigma=0.5:  reward = exp(-0.1/0.5) = exp(-0.2) â‰ˆ 0.819  (å®½æ¾)
```

#### å¥–åŠ±æ›²çº¿å¯è§†åŒ–

```
å¥–åŠ±å€¼
1.0 â”¤â—
    â”‚  â—â—
0.8 â”¤     â—â—
    â”‚        â—â—
0.6 â”¤           â—â—
    â”‚              â—â—
0.4 â”¤                 â—â—
    â”‚                    â—â—
0.2 â”¤                       â—â—â—
    â”‚                           â—â—â—â—
0.0 â”¤                                â—â—â—â—â—â—â—â—
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    0   0.25  0.5  0.75  1.0  1.25  1.5  è¯¯å·®(m/s)Â²

sigma=0.25 æ—¶çš„é«˜æ–¯å¥–åŠ±æ›²çº¿
```

**ç›®çš„ï¼š** é¼“åŠ±æœºå™¨äººè·Ÿè¸ªå‘½ä»¤çš„çº¿æ€§é€Ÿåº¦ï¼ˆx, y æ–¹å‘ï¼‰

**å…¬å¼ï¼š**
```python
lin_vel_error = sum((commands[:, :2] - base_lin_vel[:, :2])^2)
reward = exp(-lin_vel_error / tracking_sigma)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- ä½¿ç”¨é«˜æ–¯è¯¯å·®å‡½æ•°ï¼Œå½“é€Ÿåº¦è¯¯å·®ä¸º 0 æ—¶å¥–åŠ±æœ€å¤§ï¼ˆå€¼ä¸º 1ï¼‰
- `tracking_sigma` æ§åˆ¶å¥–åŠ±å‡½æ•°çš„å®½åº¦ï¼ˆé»˜è®¤ 0.25ï¼‰
- è¯¯å·®è¶Šå°ï¼Œå¥–åŠ±è¶Šæ¥è¿‘ 1ï¼›è¯¯å·®è¶Šå¤§ï¼Œå¥–åŠ±æŒ‡æ•°è¡°å‡

**é»˜è®¤æƒé‡ï¼š** `1.0` ï¼ˆæ­£å¥–åŠ±ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** æ‰€æœ‰éœ€è¦é€Ÿåº¦æ§åˆ¶çš„ä»»åŠ¡

---

### 2. tracking_ang_vel - è§’é€Ÿåº¦è·Ÿè¸ªå¥–åŠ±

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1116-1119 è¡Œ

#### å®Œæ•´æºä»£ç ï¼ˆå¸¦è¯¦ç»†æ³¨é‡Šï¼‰

```python
def _reward_tracking_ang_vel(self):
    """
    è®¡ç®—è§’é€Ÿåº¦è·Ÿè¸ªå¥–åŠ±
    
    ç›®æ ‡ï¼šé¼“åŠ±æœºå™¨äººçš„å®é™…yawè§’é€Ÿåº¦æ¥è¿‘å‘½ä»¤è§’é€Ÿåº¦
    æ–¹æ³•ï¼šä½¿ç”¨é«˜æ–¯è¯¯å·®å‡½æ•°ï¼Œç±»ä¼¼äºçº¿æ€§é€Ÿåº¦è·Ÿè¸ª
    
    Returns:
        torch.Tensor: å½¢çŠ¶[num_envs]ï¼Œæ¯ä¸ªç¯å¢ƒçš„å¥–åŠ±å€¼ï¼ŒèŒƒå›´(0, 1]
    """
    # Tracking of angular velocity commands (yaw) 
    # è®¡ç®—è§’é€Ÿåº¦è·Ÿè¸ªè¯¯å·®ï¼ˆä»…è€ƒè™‘zè½´/yawæ–¹å‘çš„æ—‹è½¬ï¼‰
    ang_vel_error = torch.square(self.commands[:, 2] - self.base_ang_vel[:, 2])
    
    # ä½¿ç”¨é«˜æ–¯å‡½æ•°å°†è¯¯å·®è½¬æ¢ä¸ºå¥–åŠ±
    return torch.exp(-ang_vel_error/self.cfg.rewards.tracking_sigma)
```

#### é€è¡Œä»£ç è¯¦è§£

**ç¬¬1-9è¡Œï¼šå‡½æ•°å®šä¹‰**
```python
def _reward_tracking_ang_vel(self):
```
- **åŠŸèƒ½**: è¯„ä¼°æœºå™¨äººè½¬å‘æ§åˆ¶çš„å‡†ç¡®æ€§
- **é¢‘ç‡**: æ¯ä¸ªä»¿çœŸæ­¥éª¤è°ƒç”¨ä¸€æ¬¡
- **é‡è¦æ€§**: æƒé‡é€šå¸¸ä¸ºçº¿æ€§é€Ÿåº¦çš„ä¸€åŠï¼ˆ0.5 vs 1.0ï¼‰
- **åŸå› **: è§’é€Ÿåº¦è·Ÿè¸ªç›¸å¯¹ä¸å¦‚å‰è¿›é€Ÿåº¦é‡è¦

**ç¬¬11-12è¡Œï¼šè®¡ç®—è§’é€Ÿåº¦è¯¯å·®**
```python
ang_vel_error = torch.square(self.commands[:, 2] - self.base_ang_vel[:, 2])
```

**è¯¦ç»†æ‹†è§£**ï¼š
```python
# æ­¥éª¤1ï¼šæå–å‘½ä»¤çš„yawè§’é€Ÿåº¦
# self.commands[:, 2] æ˜¯æœŸæœ›çš„zè½´è§’é€Ÿåº¦ï¼ˆç»•zè½´æ—‹è½¬ï¼Œæ§åˆ¶è½¬å‘ï¼‰
# å•ä½ï¼šrad/sï¼Œæ­£å€¼è¡¨ç¤ºé€†æ—¶é’ˆæ—‹è½¬ï¼Œè´Ÿå€¼è¡¨ç¤ºé¡ºæ—¶é’ˆæ—‹è½¬
cmd_yaw_vel = self.commands[:, 2]  # å½¢çŠ¶: [num_envs]

# æ­¥éª¤2ï¼šæå–å®é™…çš„yawè§’é€Ÿåº¦
# self.base_ang_vel[:, 2] æ˜¯æœºå™¨äººæœ¬ä½“åæ ‡ç³»ä¸‹çš„zè½´è§’é€Ÿåº¦
# é€šè¿‡å››å…ƒæ•°é€†æ—‹è½¬ä»ä¸–ç•Œåæ ‡è½¬æ¢è€Œæ¥
actual_yaw_vel = self.base_ang_vel[:, 2]  # å½¢çŠ¶: [num_envs]

# æ­¥éª¤3ï¼šè®¡ç®—è¯¯å·®å¹¶å¹³æ–¹
ang_vel_error = torch.square(cmd_yaw_vel - actual_yaw_vel)  # å½¢çŠ¶: [num_envs]
```

**æ•°å­¦å…¬å¼**ï¼š
$$
E_{ang} = (\omega_z^{cmd} - \omega_z^{actual})^2
$$

å…¶ä¸­ï¼š
- $\omega_z^{cmd}$: å‘½ä»¤çš„yawè§’é€Ÿåº¦ï¼ˆrad/sï¼‰
- $\omega_z^{actual}$: å®é™…çš„yawè§’é€Ÿåº¦ï¼ˆrad/sï¼‰
- $E_{ang}$: è§’é€Ÿåº¦è¯¯å·®çš„å¹³æ–¹

**ç¤ºä¾‹è®¡ç®—**ï¼š
```python
# åœºæ™¯1ï¼šç›´çº¿è¡Œèµ°ï¼ˆä¸è½¬å‘ï¼‰
# å‘½ä»¤: yaw_rate = 0.0 rad/s
# å®é™…: yaw_rate = 0.05 rad/sï¼ˆç¨å¾®åè½¬ï¼‰
ang_vel_error = (0.0 - 0.05)^2 = 0.0025

# åœºæ™¯2ï¼šåŸåœ°æ—‹è½¬
# å‘½ä»¤: yaw_rate = 1.0 rad/sï¼ˆå¿«é€Ÿè½¬å‘ï¼‰
# å®é™…: yaw_rate = 0.9 rad/s
ang_vel_error = (1.0 - 0.9)^2 = 0.01

# åœºæ™¯3ï¼šç²¾ç¡®è·Ÿè¸ª
# å‘½ä»¤: yaw_rate = 0.5 rad/s
# å®é™…: yaw_rate = 0.5 rad/s
ang_vel_error = (0.5 - 0.5)^2 = 0.0
```

**ç¬¬14è¡Œï¼šè®¡ç®—å¥–åŠ±å€¼**
```python
return torch.exp(-ang_vel_error/self.cfg.rewards.tracking_sigma)
```

**ä¸çº¿æ€§é€Ÿåº¦çš„å¯¹æ¯”**ï¼š
```python
# çº¿æ€§é€Ÿåº¦ï¼šè¯¯å·®æ˜¯xå’Œyä¸¤ä¸ªåˆ†é‡çš„å’Œ
lin_vel_error = (vx_err)^2 + (vy_err)^2

# è§’é€Ÿåº¦ï¼šè¯¯å·®åªæœ‰zè½´ä¸€ä¸ªåˆ†é‡
ang_vel_error = (wz_err)^2

# ä¸¤è€…ä½¿ç”¨ç›¸åŒçš„sigmaå‚æ•°å’Œé«˜æ–¯å‡½æ•°å½¢å¼
reward = exp(-error / tracking_sigma)
```

**ä¸ºä»€ä¹ˆåªè·Ÿè¸ªyawï¼ˆzè½´ï¼‰**ï¼š
1. **Rollå’ŒPitchç¨³å®šæ€§**: æœºå™¨äººåº”è¯¥ä¿æŒèº«ä½“æ°´å¹³ï¼Œä¸åº”è¯¥ç»•xã€yè½´æ—‹è½¬
2. **è¿åŠ¨å­¦çº¦æŸ**: å››è¶³æœºå™¨äººçš„rollå’Œpitchä¸»è¦ç”±è…¿éƒ¨é…ç½®å†³å®šï¼Œä¸ç›´æ¥æ§åˆ¶
3. **Yawæ§åˆ¶è‡ªç”±åº¦**: è½¬å‘æ˜¯å”¯ä¸€éœ€è¦ä¸»åŠ¨æ§åˆ¶çš„è§’é€Ÿåº¦
4. **å…¶ä»–å¥–åŠ±å‡½æ•°**: `ang_vel_xy`è´Ÿè´£æƒ©ç½šrollå’Œpitchæ–¹å‘çš„è§’é€Ÿåº¦

**å¥–åŠ±æ›²çº¿ç‰¹æ€§**ï¼š
```python
# tracking_sigma = 0.25 æ—¶
# è§’é€Ÿåº¦è¯¯å·® â†’ å¥–åŠ±å€¼
# 0.00 rad/s â†’ 1.000 (å®Œç¾è·Ÿè¸ª)
# 0.05 rad/s â†’ 0.951 (å¾ˆå¥½)
# 0.10 rad/s â†’ 0.819 (è‰¯å¥½)
# 0.25 rad/s â†’ 0.368 (ä¸€èˆ¬)
# 0.50 rad/s â†’ 0.135 (è¾ƒå·®)
```

**è°ƒä¼˜å»ºè®®**ï¼š
- **æƒé‡ = 0.5**: æ ‡å‡†è®¾ç½®ï¼Œè½¬å‘é‡è¦æ€§ä¸ºçº¿é€Ÿåº¦çš„ä¸€åŠ
- **æƒé‡ = 1.0**: å¢å¼ºè½¬å‘æ§åˆ¶ï¼Œé€‚ç”¨äºéœ€è¦é¢‘ç¹è½¬å‘çš„ä»»åŠ¡
- **æƒé‡ = 0.2**: é™ä½è½¬å‘é‡è¦æ€§ï¼Œä¼˜å…ˆè€ƒè™‘ç›´çº¿è¡Œèµ°
- **tracking_sigmaè°ƒæ•´**: 
  - å‡å°sigmaï¼šè¦æ±‚æ›´ç²¾ç¡®çš„è§’é€Ÿåº¦æ§åˆ¶
  - å¢å¤§sigmaï¼šå…è®¸æ›´å¤§çš„è§’é€Ÿåº¦åå·®

**é»˜è®¤æƒé‡ï¼š** `0.5` ï¼ˆæ­£å¥–åŠ±ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦è½¬å‘å’Œæ–¹å‘æ§åˆ¶çš„ä»»åŠ¡ï¼Œå¦‚å¯¼èˆªã€è·¯å¾„è·Ÿè¸ª

---

### 3. lin_vel_z - å‚ç›´çº¿æ€§é€Ÿåº¦æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1121-1123 è¡Œ

#### å®Œæ•´æºä»£ç ï¼ˆå¸¦è¯¦ç»†æ³¨é‡Šï¼‰

```python
def _reward_lin_vel_z(self):
    """
    æƒ©ç½šå‚ç›´æ–¹å‘(zè½´)çš„çº¿é€Ÿåº¦
    
    ç›®æ ‡ï¼šé¼“åŠ±æœºå™¨äººä¿æŒå¹³ç¨³çš„æ°´å¹³è¿åŠ¨ï¼Œé¿å…è·³è·ƒæˆ–ä¸Šä¸‹æŒ¯è¡
    æ–¹æ³•ï¼šå¯¹zè½´é€Ÿåº¦çš„å¹³æ–¹è¿›è¡Œæƒ©ç½šï¼ˆè´Ÿå¥–åŠ±ï¼‰
    
    Returns:
        torch.Tensor: å½¢çŠ¶[num_envs]ï¼Œè´Ÿå€¼æƒ©ç½šï¼ŒèŒƒå›´(-âˆ, 0]
    """
    # Penalize z axis base linear velocity
    # æƒ©ç½šåŸºåº§åœ¨å‚ç›´æ–¹å‘ï¼ˆzè½´ï¼‰çš„çº¿é€Ÿåº¦
    # base_lin_vel[:, 2] æ˜¯æœºå™¨äººæœ¬ä½“åæ ‡ç³»ä¸‹çš„å‚ç›´é€Ÿåº¦
    return torch.square(self.base_lin_vel[:, 2])
```

#### é€è¡Œä»£ç è¯¦è§£

**å‡½æ•°ç‰¹æ€§**ï¼š
```python
def _reward_lin_vel_z(self):
```
- **è¿”å›å€¼**: æ­£å€¼ï¼ˆä¼šè¢«è´Ÿæƒé‡å˜æˆæƒ©ç½šï¼‰
- **ä½œç”¨æ—¶æœº**: æŒç»­ä½œç”¨äºæ¯ä¸ªæ—¶é—´æ­¥
- **ç‰©ç†æ„ä¹‰**: æŠ‘åˆ¶å‚ç›´æ–¹å‘çš„è¿åŠ¨

**è®¡ç®—è¿‡ç¨‹**ï¼š
```python
return torch.square(self.base_lin_vel[:, 2])
```

**è¯¦ç»†æ‹†è§£**ï¼š
```python
# æ­¥éª¤1ï¼šæå–zè½´é€Ÿåº¦ï¼ˆå‚ç›´æ–¹å‘ï¼‰
# base_lin_vel æ˜¯æœºå™¨äººåŸºåº§åœ¨æœ¬ä½“åæ ‡ç³»ä¸‹çš„çº¿é€Ÿåº¦
# [:, 0] = xæ–¹å‘é€Ÿåº¦ï¼ˆå‰è¿›/åé€€ï¼‰
# [:, 1] = yæ–¹å‘é€Ÿåº¦ï¼ˆå·¦ç§»/å³ç§»ï¼‰  
# [:, 2] = zæ–¹å‘é€Ÿåº¦ï¼ˆä¸Šå‡/ä¸‹é™ï¼‰
z_velocity = self.base_lin_vel[:, 2]  # å½¢çŠ¶: [num_envs]

# æ­¥éª¤2ï¼šè®¡ç®—å¹³æ–¹
# ä½¿ç”¨å¹³æ–¹è€Œéç»å¯¹å€¼çš„åŸå› ï¼š
# 1. å¹³æ–¹å‡½æ•°å¯å¾®åˆ†ï¼Œæ¢¯åº¦æ›´å¹³æ»‘
# 2. å¯¹å¤§çš„é€Ÿåº¦åå·®æƒ©ç½šæ›´é‡
# 3. æ— è®ºä¸Šå‡è¿˜æ˜¯ä¸‹é™éƒ½ä¼šè¢«æƒ©ç½š
penalty = torch.square(z_velocity)  # å½¢çŠ¶: [num_envs]

# æ­¥éª¤3ï¼šåº”ç”¨è´Ÿæƒé‡ï¼ˆåœ¨é…ç½®ä¸­ï¼‰
# æœ€ç»ˆå¥–åŠ± = penalty * weight (weighté€šå¸¸ä¸º-2.0)
# æœ€ç»ˆå¥–åŠ±æ˜¯è´Ÿå€¼ï¼Œæ„æˆæƒ©ç½š
```

**æ•°å­¦å…¬å¼**ï¼š
$$
r = -(v_z)^2
$$

å…¶ä¸­ï¼š
- $v_z$: å‚ç›´æ–¹å‘é€Ÿåº¦ï¼ˆm/sï¼‰
- $r$: å¥–åŠ±å€¼ï¼ˆåº”ç”¨æƒé‡åä¸ºè´Ÿï¼‰

**ç¤ºä¾‹è®¡ç®—**ï¼š
```python
# åœºæ™¯1ï¼šå¹³ç¨³è¡Œèµ°
# z_velocity = 0.01 m/sï¼ˆå‡ ä¹é™æ­¢ï¼‰
penalty = (0.01)^2 = 0.0001
final_reward = 0.0001 * (-2.0) = -0.0002  # å‡ ä¹æ— æƒ©ç½š

# åœºæ™¯2ï¼šè½»å¾®è·³è·ƒ
# z_velocity = 0.1 m/s
penalty = (0.1)^2 = 0.01
final_reward = 0.01 * (-2.0) = -0.02

# åœºæ™¯3ï¼šå¤§å¹…è·³è·ƒ
# z_velocity = 0.5 m/s
penalty = (0.5)^2 = 0.25
final_reward = 0.25 * (-2.0) = -0.5  # ä¸¥é‡æƒ©ç½š

# åœºæ™¯4ï¼šå¿«é€Ÿä¸‹è½
# z_velocity = -0.3 m/sï¼ˆè´Ÿå€¼è¡¨ç¤ºä¸‹é™ï¼‰
penalty = (-0.3)^2 = 0.09  # å¹³æ–¹æ¶ˆé™¤ç¬¦å·
final_reward = 0.09 * (-2.0) = -0.18
```

**ä¸ºä»€ä¹ˆæƒ©ç½šå‚ç›´é€Ÿåº¦**ï¼š

1. **ç‰©ç†çº¦æŸ**: 
   - å››è¶³æœºå™¨äººä¸»è¦ç”¨äºåœ°é¢ç§»åŠ¨ï¼Œä¸åº”æœ‰æ˜¾è‘—å‚ç›´è¿åŠ¨
   - é¢‘ç¹çš„è·³è·ƒä¼šå¯¼è‡´èƒ½é‡æµªè´¹å’Œæœºæ¢°ç£¨æŸ

2. **ç¨³å®šæ€§è€ƒè™‘**:
   - å‚ç›´æŒ¯è¡ä¼šå½±å“ä¼ æ„Ÿå™¨è¯»æ•°ï¼ˆå¦‚ç›¸æœºï¼‰
   - å¢åŠ æ§åˆ¶éš¾åº¦å’Œä¸ç¡®å®šæ€§

3. **å®‰å…¨æ€§**:
   - é¿å…æœºå™¨äººå¤±æ§è·³è·ƒ
   - å‡å°‘ç€é™†æ—¶çš„å†²å‡»åŠ›

4. **èƒ½æ•ˆ**:
   - æŠ¬èµ·æ•´ä¸ªæœºä½“éœ€è¦å¤§é‡èƒ½é‡
   - å¹³ç¨³ç§»åŠ¨èƒ½æ•ˆæ›´é«˜

**ä¸å…¶ä»–å¥–åŠ±çš„é…åˆ**ï¼š
```python
# base_height: æƒ©ç½šåç¦»æœŸæœ›é«˜åº¦
# lin_vel_z: æƒ©ç½šå‚ç›´æ–¹å‘çš„é€Ÿåº¦
# feet_air_time: å¥–åŠ±åˆç†çš„è…¾ç©ºæ—¶é—´ï¼ˆæ­¥æ€ï¼‰

# ä¸‰è€…é…åˆå®ç°ï¼š
# 1. ä¿æŒç¨³å®šçš„èº«ä½“é«˜åº¦ï¼ˆbase_heightï¼‰
# 2. é¿å…æ•´ä½“ä¸Šä¸‹æŒ¯è¡ï¼ˆlin_vel_zï¼‰
# 3. å…è®¸è„šçš„æŠ¬èµ·å’Œè½åœ°ï¼ˆfeet_air_timeï¼‰
```

**è°ƒä¼˜æŒ‡å—**ï¼š

| æƒé‡å€¼ | è¡Œä¸ºç‰¹å¾ | é€‚ç”¨åœºæ™¯ |
|--------|----------|----------|
| -0.5 | å…è®¸è¾ƒå¤§å‚ç›´è¿åŠ¨ | å´å²–åœ°å½¢ï¼Œéœ€è¦è·¨è¶Šéšœç¢ |
| -2.0 | æ ‡å‡†çº¦æŸ | å¹³åœ°è¡Œèµ°ï¼ˆé»˜è®¤ï¼‰ |
| -5.0 | ä¸¥æ ¼é™åˆ¶å‚ç›´è¿åŠ¨ | å¹³æ»‘åœ°é¢ï¼Œé«˜ç¨³å®šæ€§è¦æ±‚ |
| -10.0 | æåº¦æŠ‘åˆ¶è·³è·ƒ | ç²¾å¯†æ“ä½œï¼Œè½½ç‰©è¿è¾“ |

**å¸¸è§é—®é¢˜**ï¼š

**Q1: ä¸ºä»€ä¹ˆä¸ç”¨ç»å¯¹å€¼è€Œç”¨å¹³æ–¹ï¼Ÿ**
```python
# æ–¹æ¡ˆ1ï¼šç»å¯¹å€¼
penalty = torch.abs(z_velocity)  # åœ¨é›¶ç‚¹ä¸å¯å¾®

# æ–¹æ¡ˆ2ï¼šå¹³æ–¹ï¼ˆé‡‡ç”¨ï¼‰
penalty = torch.square(z_velocity)  # å¤„å¤„å¯å¾®ï¼Œæ¢¯åº¦å¹³æ»‘
```

**Q2: è¿™ä¼šé˜»æ­¢æ­£å¸¸çš„æ­¥æ€å—ï¼Ÿ**
```
ä¸ä¼šã€‚æ­£å¸¸çš„æ­¥æ€æ¶‰åŠè…¿éƒ¨æŠ¬èµ·ï¼Œä¸æ˜¯æ•´ä¸ªèº«ä½“çš„å‚ç›´è¿åŠ¨ã€‚
- è…¿éƒ¨è¿åŠ¨ï¼šfeet_air_timeå¥–åŠ±é¼“åŠ±
- èº«ä½“å‚ç›´è¿åŠ¨ï¼šlin_vel_zæƒ©ç½šæŠ‘åˆ¶
```

**é»˜è®¤æƒé‡ï¼š** `-2.0` ï¼ˆè´Ÿå¥–åŠ±/æƒ©ç½šï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦å¹³ç¨³æ°´å¹³è¿åŠ¨çš„åœºæ™¯ï¼Œå¹³åœ°å¯¼èˆªï¼Œç‰©ä½“è¿è¾“

---

### 4. ang_vel_xy - ä¿¯ä»°æ»šè½¬è§’é€Ÿåº¦æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1125-1127 è¡Œ

#### å®Œæ•´æºä»£ç ï¼ˆå¸¦è¯¦ç»†æ³¨é‡Šï¼‰

```python
def _reward_ang_vel_xy(self):
    """
    æƒ©ç½šrollå’Œpitchæ–¹å‘çš„è§’é€Ÿåº¦
    
    ç›®æ ‡ï¼šé¼“åŠ±æœºå™¨äººä¿æŒèº«ä½“å§¿æ€ç¨³å®šï¼Œé¿å…ç»•xè½´ï¼ˆrollï¼‰å’Œyè½´ï¼ˆpitchï¼‰çš„æ—‹è½¬
    æ–¹æ³•ï¼šå¯¹xå’Œyè½´è§’é€Ÿåº¦çš„å¹³æ–¹å’Œè¿›è¡Œæƒ©ç½š
    
    Returns:
        torch.Tensor: å½¢çŠ¶[num_envs]ï¼Œæ­£å€¼ï¼ˆä¼šè¢«è´Ÿæƒé‡å˜æˆæƒ©ç½šï¼‰
    """
    # Penalize xy axes base angular velocity
    # æƒ©ç½šåŸºåº§åœ¨roll(x)å’Œpitch(y)æ–¹å‘çš„è§’é€Ÿåº¦
    # åªå…è®¸yaw(z)æ–¹å‘çš„æ—‹è½¬ï¼Œç”±tracking_ang_velæ§åˆ¶
    return torch.sum(torch.square(self.base_ang_vel[:, :2]), dim=1)
```

#### é€è¡Œä»£ç è¯¦è§£

**åæ ‡ç³»è¯´æ˜**ï¼š
```
æœºå™¨äººæœ¬ä½“åæ ‡ç³»ï¼ˆBody Frameï¼‰ï¼š
- Xè½´ï¼šæŒ‡å‘å‰æ–¹ â†’ Rollï¼ˆä¾§ç¿»ï¼‰
- Yè½´ï¼šæŒ‡å‘å·¦ä¾§ â†’ Pitchï¼ˆä¿¯ä»°ï¼‰
- Zè½´ï¼šæŒ‡å‘ä¸Šæ–¹ â†’ Yawï¼ˆè½¬å‘ï¼‰

     Zâ†‘ (Yaw)
      |
      |
      â—----â†’ X (Roll)
     /
    / Y (Pitch)
```

**è®¡ç®—è¿‡ç¨‹**ï¼š
```python
return torch.sum(torch.square(self.base_ang_vel[:, :2]), dim=1)
```

**è¯¦ç»†æ‹†è§£**ï¼š
```python
# æ­¥éª¤1ï¼šæå–rollå’Œpitchè§’é€Ÿåº¦
# base_ang_vel[:, 0] = ç»•xè½´çš„è§’é€Ÿåº¦ï¼ˆrollï¼Œæœºå™¨äººä¾§ç¿»ï¼‰
# base_ang_vel[:, 1] = ç»•yè½´çš„è§’é€Ÿåº¦ï¼ˆpitchï¼Œæœºå™¨äººå‰åä¿¯ä»°ï¼‰
# base_ang_vel[:, 2] = ç»•zè½´çš„è§’é€Ÿåº¦ï¼ˆyawï¼Œæœºå™¨äººè½¬å‘ï¼‰- ä¸æƒ©ç½š
roll_pitch_vel = self.base_ang_vel[:, :2]  # å½¢çŠ¶: [num_envs, 2]

# æ­¥éª¤2ï¼šè®¡ç®—å¹³æ–¹
# ä½¿ç”¨å¹³æ–¹æƒ©ç½šï¼Œæ— è®ºæ­£å‘è¿˜æ˜¯è´Ÿå‘æ—‹è½¬éƒ½è¢«æƒ©ç½š
squared_vel = torch.square(roll_pitch_vel)  # å½¢çŠ¶: [num_envs, 2]

# æ­¥éª¤3ï¼šå¯¹ä¸¤ä¸ªæ–¹å‘æ±‚å’Œ
# rollå’Œpitchçš„è§’é€Ÿåº¦æƒ©ç½šç´¯åŠ 
penalty = torch.sum(squared_vel, dim=1)  # å½¢çŠ¶: [num_envs]

# åº”ç”¨è´Ÿæƒé‡åï¼šfinal_reward = penalty * (-0.05)
```

**æ•°å­¦å…¬å¼**ï¼š
$$
r = -(\omega_x^2 + \omega_y^2)
$$

å…¶ä¸­ï¼š
- $\omega_x$: rollè§’é€Ÿåº¦ï¼ˆrad/sï¼‰
- $\omega_y$: pitchè§’é€Ÿåº¦ï¼ˆrad/sï¼‰
- $r$: å¥–åŠ±å€¼ï¼ˆåº”ç”¨æƒé‡-0.05åï¼‰

**ç¤ºä¾‹è®¡ç®—**ï¼š
```python
# åœºæ™¯1ï¼šå®Œç¾ç¨³å®š
# roll_vel = 0.0 rad/s, pitch_vel = 0.0 rad/s
penalty = 0.0^2 + 0.0^2 = 0.0
final_reward = 0.0 * (-0.05) = 0.0  # æ— æƒ©ç½š

# åœºæ™¯2ï¼šè½»å¾®æ™ƒåŠ¨
# roll_vel = 0.1 rad/s, pitch_vel = 0.05 rad/s
penalty = 0.1^2 + 0.05^2 = 0.01 + 0.0025 = 0.0125
final_reward = 0.0125 * (-0.05) = -0.000625

# åœºæ™¯3ï¼šå‰§çƒˆæ‘‡æ™ƒ
# roll_vel = 0.5 rad/s, pitch_vel = 0.3 rad/s
penalty = 0.5^2 + 0.3^2 = 0.25 + 0.09 = 0.34
final_reward = 0.34 * (-0.05) = -0.017

# åœºæ™¯4ï¼šå¿«é€Ÿpitchï¼ˆå¦‚çˆ¬å¡ï¼‰
# roll_vel = 0.0 rad/s, pitch_vel = 0.8 rad/s
penalty = 0.0^2 + 0.8^2 = 0.64
final_reward = 0.64 * (-0.05) = -0.032
```

**ç‰©ç†æ„ä¹‰å’Œè®¾è®¡ç†ç”±**ï¼š

**1. ä¸ºä»€ä¹ˆæƒ©ç½šrollå’Œpitchï¼Ÿ**
```python
# Rollï¼ˆä¾§ç¿»ï¼‰é—®é¢˜ï¼š
# - å¯¼è‡´æœºå™¨äººå¤±è¡¡
# - å½±å“è¶³ç«¯æ¥è§¦åŠ›åˆ†å¸ƒ
# - å¯èƒ½å¯¼è‡´ç¿»å€’

# Pitchï¼ˆä¿¯ä»°ï¼‰é—®é¢˜ï¼š
# - å½±å“å‰è¿›æ–¹å‘ç¨³å®šæ€§
# - å½±å“ä¼ æ„Ÿå™¨è§†é‡
# - å¢åŠ æ§åˆ¶éš¾åº¦
```

**2. ä¸ºä»€ä¹ˆä¸æƒ©ç½šyawï¼Ÿ**
```python
# Yawï¼ˆè½¬å‘ï¼‰æ˜¯å¿…éœ€çš„ï¼š
# - æœºå™¨äººéœ€è¦æ”¹å˜æœå‘
# - tracking_ang_velä¸“é—¨å¤„ç†yawæ§åˆ¶
# - åˆ†ç¦»æ§åˆ¶ï¼šè½¬å‘ç”±å‘½ä»¤å†³å®šï¼Œå§¿æ€ç”±æ­¤å‡½æ•°ç¨³å®š
```

**3. æƒé‡ä¸ºä½•è¾ƒå°ï¼ˆ-0.05ï¼‰ï¼Ÿ**
```python
# ç›¸å¯¹è¾ƒå°çš„æƒé‡åŸå› ï¼š
# 1. è¡Œèµ°æ—¶è‡ªç„¶ä¼šæœ‰è½»å¾®çš„pitchå’Œroll
# 2. è¿‡åº¦æƒ©ç½šä¼šå¯¼è‡´åƒµç¡¬çš„æ­¥æ€
# 3. ä¸»è¦èµ·å¾®è°ƒä½œç”¨ï¼Œä¸æ˜¯æ ¸å¿ƒçº¦æŸ
# 4. ä¸orientationé…åˆä½¿ç”¨ï¼ˆé™æ€å§¿æ€çº¦æŸï¼‰
```

**ä¸ç›¸å…³å¥–åŠ±å‡½æ•°çš„å…³ç³»**ï¼š

```
å§¿æ€æ§åˆ¶ä½“ç³»ï¼š
â”‚
â”œâ”€â”€ orientation: æƒ©ç½šå§¿æ€è§’åº¦åå·®ï¼ˆé™æ€ï¼‰
â”‚   â””â”€ ç›®æ ‡ï¼šèº«ä½“ä¿æŒæ°´å¹³
â”‚
â”œâ”€â”€ ang_vel_xy: æƒ©ç½šroll/pitchè§’é€Ÿåº¦ï¼ˆåŠ¨æ€ï¼‰
â”‚   â””â”€ ç›®æ ‡ï¼šå§¿æ€å˜åŒ–å¹³ç¨³
â”‚
â””â”€â”€ tracking_ang_vel: è·Ÿè¸ªyawè§’é€Ÿåº¦å‘½ä»¤
    â””â”€ ç›®æ ‡ï¼šç²¾ç¡®è½¬å‘æ§åˆ¶
```

**å…¸å‹æ•°å€¼èŒƒå›´**ï¼š
```python
# æ­£å¸¸è¡Œèµ°ï¼š
# roll_vel: Â±0.1 rad/s
# pitch_vel: Â±0.15 rad/s
# penalty: ~0.035
# reward: -0.00175

# å¿«é€Ÿå¥”è·‘ï¼š
# roll_vel: Â±0.3 rad/s
# pitch_vel: Â±0.4 rad/s
# penalty: ~0.25
# reward: -0.0125

# ä¸ç¨³å®šçŠ¶æ€ï¼š
# roll_vel: Â±1.0 rad/s
# pitch_vel: Â±0.8 rad/s
# penalty: ~1.64
# reward: -0.082  # æ˜¾è‘—æƒ©ç½š
```

**è°ƒä¼˜å»ºè®®**ï¼š

| æƒé‡å€¼ | æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|--------|------|----------|
| -0.01 | å…è®¸è¾ƒå¤§å§¿æ€å˜åŒ– | å´å²–åœ°å½¢ï¼ŒåŠ¨æ€è¿åŠ¨ |
| -0.05 | æ ‡å‡†çº¦æŸ | ä¸€èˆ¬å¹³åœ°è¡Œèµ°ï¼ˆé»˜è®¤ï¼‰ |
| -0.1 | è¾ƒå¼ºçº¦æŸ | é«˜ç¨³å®šæ€§è¦æ±‚ |
| -0.5 | ä¸¥æ ¼é™åˆ¶ | ç²¾å¯†ä»»åŠ¡ï¼Œè½½ç‰©è¿è¾“ |

**å¸¸è§é—®é¢˜**ï¼š

**Q: è¿™ä¼šé™åˆ¶æœºå™¨äººåœ¨æ–œå¡ä¸Šè¡Œèµ°å—ï¼Ÿ**
```
ä¸ä¼šã€‚è¿™ä¸ªå¥–åŠ±æƒ©ç½šçš„æ˜¯è§’é€Ÿåº¦ï¼ˆå˜åŒ–ç‡ï¼‰ï¼Œä¸æ˜¯è§’åº¦æœ¬èº«ã€‚
- ç¨³å®šçˆ¬å¡ï¼špitchè§’åº¦å¤§ï¼Œä½†pitchè§’é€Ÿåº¦å° â†’ å°æƒ©ç½š
- ä¸ç¨³å®šæ™ƒåŠ¨ï¼špitchè§’é€Ÿåº¦å¤§ â†’ å¤§æƒ©ç½š
orientationå‡½æ•°è´Ÿè´£é™åˆ¶è§’åº¦åå·®
```

**Q: ä¸ºä»€ä¹ˆä½¿ç”¨å¹³æ–¹å’Œè€Œä¸æ˜¯æœ€å¤§å€¼ï¼Ÿ**
```python
# æ–¹æ¡ˆ1ï¼šå¹³æ–¹å’Œï¼ˆé‡‡ç”¨ï¼‰
penalty = roll_vel^2 + pitch_vel^2
# ä¼˜ç‚¹ï¼šåŒæ—¶è€ƒè™‘ä¸¤ä¸ªæ–¹å‘ï¼Œé¼“åŠ±æ•´ä½“ç¨³å®š

# æ–¹æ¡ˆ2ï¼šæœ€å¤§å€¼
penalty = max(roll_vel^2, pitch_vel^2)
# ç¼ºç‚¹ï¼šå¿½ç•¥å¦ä¸€ä¸ªæ–¹å‘ï¼Œå¯èƒ½å¯¼è‡´åç½®è¡Œä¸º
```

**é»˜è®¤æƒé‡ï¼š** `-0.05` ï¼ˆè´Ÿå¥–åŠ±/æƒ©ç½šï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** æ‰€æœ‰éœ€è¦ç¨³å®šå§¿æ€çš„ä»»åŠ¡ï¼Œå°¤å…¶æ˜¯è´Ÿè½½è¿è¾“ã€ç²¾å¯†æ“ä½œ

---

### 5. orientation - èº«ä½“å§¿æ€æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šæœºå™¨äººèº«ä½“åç¦»æ°´å¹³å§¿æ€

**å…¬å¼ï¼š**
```python
reward = -sum(projected_gravity[:, :2]^2)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- `projected_gravity` æ˜¯é‡åŠ›å‘é‡åœ¨æœºå™¨äººèº«ä½“åæ ‡ç³»ä¸­çš„æŠ•å½±
- å½“æœºå™¨äººèº«ä½“æ°´å¹³æ—¶ï¼Œé‡åŠ›ä»…åœ¨ z æ–¹å‘ï¼Œx å’Œ y åˆ†é‡ä¸º 0
- èº«ä½“å€¾æ–œæ—¶ï¼Œx å’Œ y åˆ†é‡å¢å¤§ï¼Œæƒ©ç½šå¢åŠ 

**é»˜è®¤æƒé‡ï¼š** `-0.2`ï¼ˆAliengoï¼‰/ `-0.0`ï¼ˆåŸºç¡€é…ç½®ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦ä¿æŒèº«ä½“æ°´å¹³çš„åœºæ™¯

---

### 6. dof_acc - å…³èŠ‚åŠ é€Ÿåº¦æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šå…³èŠ‚çš„å‰§çƒˆåŠ é€Ÿåº¦å˜åŒ–ï¼Œé¼“åŠ±å¹³æ»‘è¿åŠ¨

**å…¬å¼ï¼š**
```python
dof_acc = (last_dof_vel - dof_vel) / dt
reward = -sum(dof_acc^2)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- é€šè¿‡ç›¸é‚»æ—¶é—´æ­¥çš„é€Ÿåº¦å·®è®¡ç®—åŠ é€Ÿåº¦
- æƒ©ç½šå…³èŠ‚çš„æ€¥å‰§åŠ å‡é€Ÿ
- æœ‰åŠ©äºå‡å°‘å†²å‡»åŠ›å’Œèƒ½é‡æ¶ˆè€—

**é»˜è®¤æƒé‡ï¼š** `-2.5e-7` ï¼ˆæå°çš„è´Ÿå¥–åŠ±ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** æ‰€æœ‰éœ€è¦å¹³æ»‘è¿åŠ¨çš„ä»»åŠ¡

---

### 7. joint_power - å…³èŠ‚åŠŸç‡æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šé«˜åŠŸç‡æ¶ˆè€—ï¼Œé¼“åŠ±èƒ½æ•ˆè¿åŠ¨

**å…¬å¼ï¼š**
```python
reward = -sum(|dof_vel| * |torques|)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- åŠŸç‡ = é€Ÿåº¦ Ã— åŠ›çŸ©
- é¼“åŠ±æœºå™¨äººä»¥æ›´èŠ‚èƒ½çš„æ–¹å¼è¿åŠ¨
- é˜²æ­¢ä¸å¿…è¦çš„é«˜é€Ÿå…³èŠ‚è¿åŠ¨å’Œå¤§åŠ›çŸ©è¾“å‡º

**é»˜è®¤æƒé‡ï¼š** `-2e-5`ï¼ˆAliengoï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦è€ƒè™‘èƒ½æ•ˆçš„å®é™…éƒ¨ç½²åœºæ™¯

---

### 8. base_height - èº«ä½“é«˜åº¦æƒ©ç½š

**ç›®çš„ï¼š** é¼“åŠ±æœºå™¨äººä¿æŒç›®æ ‡èº«ä½“é«˜åº¦

**å…¬å¼ï¼š**
```python
reward = -(base_height - base_height_target)^2
```

**è¯¦ç»†è¯´æ˜ï¼š**
- æƒ©ç½šä¸ç›®æ ‡é«˜åº¦çš„åå·®
- é˜²æ­¢æœºå™¨äººè¹²å¾—å¤ªä½æˆ–ç«™å¾—å¤ªé«˜
- `base_height_target` é€šå¸¸è®¾ç½®ä¸ºæœºå™¨äººçš„è‡ªç„¶ç«™ç«‹é«˜åº¦

**é»˜è®¤æƒé‡ï¼š** `-1.0`ï¼ˆAliengoï¼‰/ `-0.0`ï¼ˆåŸºç¡€é…ç½®ï¼‰

**é…ç½®å‚æ•°ï¼š**
- `base_height_target`: 0.30 ç±³ï¼ˆAliengoï¼‰

---

### 9. foot_clearance - è¶³ç«¯ç¦»åœ°é«˜åº¦å¥–åŠ±

**ç›®çš„ï¼š** åœ¨æ‘†åŠ¨ç›¸æ—¶é¼“åŠ±è¶³ç«¯ä¿æŒä¸€å®šçš„ç¦»åœ°é«˜åº¦

**å…¬å¼ï¼š**
```python
height_error = (foot_z_position - clearance_height_target)^2
foot_lateral_vel = sqrt(foot_vel_x^2 + foot_vel_y^2)
reward = -sum(height_error * foot_lateral_vel)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- ä»…åœ¨è¶³ç«¯æœ‰æ¨ªå‘é€Ÿåº¦æ—¶ï¼ˆæ‘†åŠ¨ç›¸ï¼‰è®¡ç®—å¥–åŠ±
- é¼“åŠ±è¶³ç«¯åœ¨æ‘†åŠ¨æ—¶ä¿æŒç›®æ ‡é«˜åº¦
- é˜²æ­¢è¶³ç«¯æ‹–åœ°ï¼Œå‡å°‘æ‘©æ“¦å’Œèƒ½é‡æŸå¤±
- è¶³ç«¯ä½ç½®å’Œé€Ÿåº¦éƒ½è½¬æ¢åˆ°æœºå™¨äººèº«ä½“åæ ‡ç³»

**é»˜è®¤æƒé‡ï¼š** `-0.01`ï¼ˆAliengoï¼‰

**é…ç½®å‚æ•°ï¼š**
- `clearance_height_target`: -0.20 ç±³ï¼ˆAliengoï¼Œè´Ÿå€¼è¡¨ç¤ºè¶³ç«¯åœ¨èº«ä½“ä¸‹æ–¹ï¼‰

---

### 10. action_rate - åŠ¨ä½œå˜åŒ–ç‡æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šç›¸é‚»æ—¶é—´æ­¥ä¹‹é—´çš„åŠ¨ä½œå˜åŒ–ï¼Œé¼“åŠ±å¹³æ»‘æ§åˆ¶

**å…¬å¼ï¼š**
```python
reward = -sum((last_actions - actions)^2)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- æƒ©ç½šåŠ¨ä½œçš„çªå˜
- é¼“åŠ±ç­–ç•¥è¾“å‡ºè¿ç»­å¹³æ»‘çš„æ§åˆ¶ä¿¡å·
- æœ‰åŠ©äºå‡å°‘æœºæ¢°ç£¨æŸå’Œæé«˜å®é™…éƒ¨ç½²çš„ç¨³å®šæ€§

**é»˜è®¤æƒé‡ï¼š** `-0.01` ï¼ˆè´Ÿå¥–åŠ±/æƒ©ç½šï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** æ‰€æœ‰å®é™…éƒ¨ç½²åœºæ™¯

---

### 11. smoothness - äºŒé˜¶å¹³æ»‘åº¦æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šåŠ¨ä½œçš„äºŒé˜¶å¯¼æ•°ï¼Œè¿›ä¸€æ­¥é¼“åŠ±å¹³æ»‘æ§åˆ¶

**å…¬å¼ï¼š**
```python
reward = -sum((actions - last_actions - last_actions + last_last_actions)^2)
      = -sum((actions - 2*last_actions + last_last_actions)^2)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- è¿™æ˜¯åŠ¨ä½œçš„äºŒé˜¶å·®åˆ†ï¼Œç±»ä¼¼äºåŠ é€Ÿåº¦
- æ¯” `action_rate` æ›´ä¸¥æ ¼çš„å¹³æ»‘åº¦çº¦æŸ
- æƒ©ç½šåŠ¨ä½œå˜åŒ–ç‡çš„å˜åŒ–

**é»˜è®¤æƒé‡ï¼š** `-0.01`ï¼ˆAliengoï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦æé«˜å¹³æ»‘åº¦çš„åœºæ™¯

---

### 12. torques - åŠ›çŸ©æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šé«˜åŠ›çŸ©è¾“å‡ºï¼Œé¼“åŠ±è½»æŸ”æ§åˆ¶

**å…¬å¼ï¼š**
```python
reward = -sum(torques^2)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- ç›´æ¥æƒ©ç½šå…³èŠ‚åŠ›çŸ©çš„å¤§å°
- é˜²æ­¢ç”µæœºè¿‡è½½
- ä¸ `joint_power` ä¸åŒï¼Œä¸è€ƒè™‘é€Ÿåº¦

**é»˜è®¤æƒé‡ï¼š** `-0.00001`ï¼ˆåŸºç¡€ï¼‰/ `-0.0`ï¼ˆAliengo ç¦ç”¨ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦ä¿æŠ¤ç¡¬ä»¶çš„åœºæ™¯

---

### 13. dof_vel - å…³èŠ‚é€Ÿåº¦æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šé«˜å…³èŠ‚é€Ÿåº¦ï¼Œé¼“åŠ±æ…¢é€Ÿå¹³ç¨³è¿åŠ¨

**å…¬å¼ï¼š**
```python
reward = -sum(dof_vel^2)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- ç›´æ¥æƒ©ç½šå…³èŠ‚é€Ÿåº¦
- é˜²æ­¢å…³èŠ‚é«˜é€Ÿè¿åŠ¨å¯¼è‡´çš„æ§åˆ¶ä¸ç¨³å®š
- æœ‰åŠ©äºå»¶é•¿æœºæ¢°å¯¿å‘½

**é»˜è®¤æƒé‡ï¼š** `-0.0` ï¼ˆé€šå¸¸ç¦ç”¨ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦ä½é€Ÿè¿åŠ¨çš„ç‰¹å®šä»»åŠ¡

---

### 14. collision - ç¢°æ’æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šéè¶³ç«¯éƒ¨ä½ä¸ç¯å¢ƒçš„ç¢°æ’

**å…¬å¼ï¼š**
```python
reward = -sum(collision_indicator)
collision_indicator = 1 if contact_force_norm > 0.1 else 0
```

**è¯¦ç»†è¯´æ˜ï¼š**
- æ£€æµ‹ç‰¹å®šèº«ä½“éƒ¨ä½ï¼ˆå¦‚æœºèº«ã€å¤§è…¿ï¼‰çš„æ¥è§¦åŠ›
- æ¥è§¦åŠ›å¤§äºé˜ˆå€¼ï¼ˆ0.1 Nï¼‰æ—¶è®¡ä¸ºä¸€æ¬¡ç¢°æ’
- é˜²æ­¢æœºå™¨äººèº«ä½“ä¸åœ°é¢æˆ–éšœç¢ç‰©ç¢°æ’

**é»˜è®¤æƒé‡ï¼š** `-1.0`ï¼ˆåŸºç¡€ï¼‰/ `-0.0`ï¼ˆAliengo ç¦ç”¨ï¼‰

**é…ç½®å‚æ•°ï¼š**
- `penalised_contact_indices`: éœ€è¦æ£€æµ‹ç¢°æ’çš„èº«ä½“éƒ¨ä½ç´¢å¼•

---

### 15. termination - ç»ˆæ­¢æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šéè¶…æ—¶çš„ç»ˆæ­¢ï¼ˆå¦‚æ‘”å€’ï¼‰

**å…¬å¼ï¼š**
```python
reward = -(reset_buf AND NOT time_out_buf)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- ä»…åœ¨éæ­£å¸¸ç»ˆæ­¢æ—¶ç»™äºˆæƒ©ç½š
- å¦‚æœæ˜¯å› ä¸ºè¶…æ—¶è€Œç»ˆæ­¢ï¼Œä¸ç»™äºˆæƒ©ç½š
- é¼“åŠ±æœºå™¨äººé¿å…å¯¼è‡´ episode æå‰ç»“æŸçš„å¤±è´¥çŠ¶æ€

**é»˜è®¤æƒé‡ï¼š** `-0.0` ï¼ˆé€šå¸¸ç¦ç”¨æˆ–è®¾ä¸º 0ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦æ˜ç¡®æƒ©ç½šå¤±è´¥çš„è®­ç»ƒæ—©æœŸ

---

### 16. dof_pos_limits - å…³èŠ‚ä½ç½®é™åˆ¶æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šå…³èŠ‚ä½ç½®æ¥è¿‘æˆ–è¶…å‡ºé™åˆ¶

**å…¬å¼ï¼š**
```python
out_of_limits_lower = -min(dof_pos - dof_pos_min, 0)
out_of_limits_upper = max(dof_pos - dof_pos_max, 0)
reward = -sum(out_of_limits_lower + out_of_limits_upper)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- å½“å…³èŠ‚ä½ç½®æ¥è¿‘ç‰©ç†é™åˆ¶æ—¶ç»™äºˆæƒ©ç½š
- é˜²æ­¢æœºå™¨äººè¿›å…¥å¥‡å¼‚ä½å½¢
- ä¿æŠ¤ç¡¬ä»¶ä¸å—æŸå

**é»˜è®¤æƒé‡ï¼š** `0.0` ï¼ˆAliengo ç¦ç”¨ï¼‰

**é…ç½®å‚æ•°ï¼š**
- `soft_dof_pos_limit`: 0.95ï¼ˆ95% çš„ URDF é™åˆ¶ï¼‰

---

### 17. dof_vel_limits - å…³èŠ‚é€Ÿåº¦é™åˆ¶æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šå…³èŠ‚é€Ÿåº¦æ¥è¿‘æˆ–è¶…å‡ºé™åˆ¶

**å…¬å¼ï¼š**
```python
over_limit = max(|dof_vel| - dof_vel_limit * soft_limit, 0)
reward = -sum(clip(over_limit, 0, 1))  # é™åˆ¶æœ€å¤§è¯¯å·®ä¸º 1 rad/s
```

**è¯¦ç»†è¯´æ˜ï¼š**
- å½“å…³èŠ‚é€Ÿåº¦è¶…è¿‡è½¯é™åˆ¶æ—¶ç»™äºˆæƒ©ç½š
- è¯¯å·®è¢«è£å‰ªåˆ°æœ€å¤§ 1 rad/sï¼Œé¿å…è¿‡å¤§æƒ©ç½š
- é˜²æ­¢ç”µæœºè¿‡é€Ÿè¿è½¬

**é»˜è®¤æƒé‡ï¼š** `0.0` ï¼ˆAliengo ç¦ç”¨ï¼‰

**é…ç½®å‚æ•°ï¼š**
- `soft_dof_vel_limit`: 0.95

---

### 18. torque_limits - åŠ›çŸ©é™åˆ¶æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šåŠ›çŸ©æ¥è¿‘æˆ–è¶…å‡ºé™åˆ¶

**å…¬å¼ï¼š**
```python
over_limit = max(|torques| - torque_limit * soft_limit, 0)
reward = -sum(over_limit)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- å½“åŠ›çŸ©è¶…è¿‡è½¯é™åˆ¶æ—¶ç»™äºˆæƒ©ç½š
- é˜²æ­¢ç”µæœºè¿‡è½½å’ŒæŸå

**é»˜è®¤æƒé‡ï¼š** `0.0` ï¼ˆAliengo ç¦ç”¨ï¼‰

**é…ç½®å‚æ•°ï¼š**
- `soft_torque_limit`: 0.95

---

### 19. feet_air_time - è¶³ç«¯æ»ç©ºæ—¶é—´å¥–åŠ±

**ç›®çš„ï¼š** å¥–åŠ±è¾ƒé•¿çš„æ­¥æ€å‘¨æœŸï¼Œé¼“åŠ±è‡ªç„¶è¡Œèµ°

**å…¬å¼ï¼š**
```python
reward = sum((feet_air_time - 0.5) * first_contact) if command_vel > 0.1 else 0
```

**è¯¦ç»†è¯´æ˜ï¼š**
- ä»…åœ¨è¶³ç«¯é¦–æ¬¡æ¥è§¦åœ°é¢æ—¶ç»™äºˆå¥–åŠ±
- å¥–åŠ± = (æ»ç©ºæ—¶é—´ - 0.5 ç§’) Ã— æ¥è§¦æŒ‡ç¤ºå™¨
- ä»…åœ¨é€Ÿåº¦å‘½ä»¤å¤§äº 0.1 æ—¶æœ‰æ•ˆï¼ˆé™æ­¢æ—¶ä¸å¥–åŠ±ï¼‰
- ä½¿ç”¨æ¥è§¦åŠ›æ»¤æ³¢å™¨æé«˜å¯é æ€§ï¼ˆPhysX åœ¨ç½‘æ ¼ä¸Šæ¥è§¦æ£€æµ‹ä¸å¯é ï¼‰

**é»˜è®¤æƒé‡ï¼š** `1.0`ï¼ˆåŸºç¡€ï¼‰/ `0.0`ï¼ˆAliengo ç¦ç”¨ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** é¼“åŠ±æ­£å¸¸æ­¥æ€çš„ä»»åŠ¡

---

### 20. feet_stumble - è¶³ç«¯ç»Šå€’æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šè¶³ç«¯ä¸å‚ç›´è¡¨é¢ç¢°æ’ï¼ˆç»Šå€’ï¼‰

**å…¬å¼ï¼š**
```python
stumble = any(horizontal_force > 5 * vertical_force)
reward = -stumble
```

**è¯¦ç»†è¯´æ˜ï¼š**
- æ£€æµ‹è¶³ç«¯çš„æ°´å¹³æ¥è§¦åŠ›æ˜¯å¦è¿œå¤§äºå‚ç›´æ¥è§¦åŠ›
- æ°´å¹³åŠ›å¤§äºå‚ç›´åŠ› 5 å€æ—¶è®¤ä¸ºæ˜¯ç»Šå€’
- é˜²æ­¢æœºå™¨äººè¸¢åˆ°éšœç¢ç‰©æˆ–å°é˜¶

**é»˜è®¤æƒé‡ï¼š** `-0.0` ï¼ˆé€šå¸¸ç¦ç”¨ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** å¤æ‚åœ°å½¢å¯¼èˆª

---

### 21. stand_still - é™æ­¢æƒ©ç½š

**ç›®çš„ï¼š** åœ¨é›¶é€Ÿåº¦å‘½ä»¤æ—¶æƒ©ç½šå…³èŠ‚åç¦»é»˜è®¤ä½ç½®

**å…¬å¼ï¼š**
```python
reward = -sum(|dof_pos - default_dof_pos|) if command_vel < 0.1 else 0
```

**è¯¦ç»†è¯´æ˜ï¼š**
- ä»…åœ¨é€Ÿåº¦å‘½ä»¤æ¥è¿‘ 0 æ—¶æ¿€æ´»
- é¼“åŠ±æœºå™¨äººåœ¨é™æ­¢æ—¶ä¿æŒé»˜è®¤ç«™ç«‹å§¿æ€
- é˜²æ­¢åœ¨åŸåœ°åšæ— æ„ä¹‰çš„åŠ¨ä½œ

**é»˜è®¤æƒé‡ï¼š** `-0.0` ï¼ˆé€šå¸¸ç¦ç”¨ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦é™æ€ç«™ç«‹çš„åœºæ™¯

---

### 22. feet_contact_forces - è¶³ç«¯æ¥è§¦åŠ›æƒ©ç½š

**ç›®çš„ï¼š** æƒ©ç½šè¿‡å¤§çš„è¶³ç«¯æ¥è§¦åŠ›

**å…¬å¼ï¼š**
```python
over_force = max(contact_force_norm - max_contact_force, 0)
reward = -sum(over_force)
```

**è¯¦ç»†è¯´æ˜ï¼š**
- æƒ©ç½šè¶…è¿‡æœ€å¤§å…è®¸æ¥è§¦åŠ›çš„æƒ…å†µ
- é˜²æ­¢ç€åœ°å†²å‡»è¿‡å¤§
- é¼“åŠ±æŸ”å’Œç€åœ°

**é»˜è®¤æƒé‡ï¼š** åœ¨ä»£ç ä¸­å®ç°ä½†æœªåœ¨é…ç½®ä¸­æ˜¾å¼åˆ—å‡º

**é…ç½®å‚æ•°ï¼š**
- `max_contact_force`: 100 N

---

## é…ç½®å‚æ•°è¯´æ˜

### Aliengo æœºå™¨äººå®Œæ•´é…ç½®

**é…ç½®æ–‡ä»¶ä½ç½®ï¼š** `legged_gym/envs/aliengo/aliengo_config.py`

#### å¥–åŠ±æƒé‡é…ç½® (rewards.scales)

```python
class rewards( LeggedRobotCfg.rewards ):
    class scales:
        # === æ€§èƒ½ç›®æ ‡ (æ­£å¥–åŠ±) ===
        tracking_lin_vel = 1.0        # çº¿æ€§é€Ÿåº¦è·Ÿè¸ª (ä¸»è¦ç›®æ ‡)
        tracking_ang_vel = 0.5        # è§’é€Ÿåº¦è·Ÿè¸ª
        
        # === ç¨³å®šæ€§çº¦æŸ (è´Ÿå¥–åŠ±) ===
        lin_vel_z = -2.0              # å‚ç›´é€Ÿåº¦æƒ©ç½š
        ang_vel_xy = -0.05            # ä¿¯ä»°æ»šè½¬æƒ©ç½š
        orientation = -0.2            # å§¿æ€åå·®æƒ©ç½š
        base_height = -1.0            # èº«ä½“é«˜åº¦æƒ©ç½š
        
        # === èƒ½æ•ˆä¼˜åŒ– (è´Ÿå¥–åŠ±) ===
        joint_power = -2e-5           # å…³èŠ‚åŠŸç‡æƒ©ç½š
        torques = -0.0                # åŠ›çŸ©æƒ©ç½š (ç¦ç”¨)
        dof_vel = -0.0                # å…³èŠ‚é€Ÿåº¦æƒ©ç½š (ç¦ç”¨)
        
        # === åŠ¨ä½œè´¨é‡ (è´Ÿå¥–åŠ±) ===
        action_rate = -0.01           # åŠ¨ä½œå˜åŒ–ç‡æƒ©ç½š
        smoothness = -0.01            # äºŒé˜¶å¹³æ»‘åº¦æƒ©ç½š
        dof_acc = -2.5e-7             # å…³èŠ‚åŠ é€Ÿåº¦æƒ©ç½š
        
        # === è¶³ç«¯æ§åˆ¶ (æ··åˆ) ===
        foot_clearance = -0.01        # è¶³ç«¯ç¦»åœ°é«˜åº¦
        feet_air_time = 0.0           # æ»ç©ºæ—¶é—´å¥–åŠ± (ç¦ç”¨)
        feet_stumble = -0.0           # ç»Šå€’æƒ©ç½š (ç¦ç”¨)
        
        # === ç‰©ç†é™åˆ¶ (è´Ÿå¥–åŠ±) ===
        dof_pos_limits = 0.0          # å…³èŠ‚ä½ç½®é™åˆ¶ (ç¦ç”¨)
        dof_vel_limits = 0.0          # å…³èŠ‚é€Ÿåº¦é™åˆ¶ (ç¦ç”¨)
        torque_limits = 0.0           # åŠ›çŸ©é™åˆ¶ (ç¦ç”¨)
        
        # === ç¢°æ’æ£€æµ‹ (è´Ÿå¥–åŠ±) ===
        collision = -0.0              # èº«ä½“ç¢°æ’ (ç¦ç”¨)
        termination = -0.0            # ç»ˆæ­¢æƒ©ç½š (ç¦ç”¨)
        
        # === ç‰¹æ®Šè¡Œä¸º (è´Ÿå¥–åŠ±) ===
        stand_still = -0.0            # é™æ­¢æƒ©ç½š (ç¦ç”¨)
```

#### å¥–åŠ±ç›¸å…³è¶…å‚æ•°

```python
class rewards:
    # === å¥–åŠ±è®¡ç®—å‚æ•° ===
    only_positive_rewards = False     # æ˜¯å¦è£å‰ªè´Ÿå¥–åŠ±
                                      # False: å…è®¸è´Ÿæ€»å¥–åŠ±
                                      # True: å°†è´Ÿæ€»å¥–åŠ±è£å‰ªä¸º0
    
    tracking_sigma = 0.25             # é€Ÿåº¦è·Ÿè¸ªå¥–åŠ±çš„é«˜æ–¯å®½åº¦
                                      # è¶Šå°: å¥–åŠ±å‡½æ•°è¶Šé™¡å³­ï¼Œå¯¹è¯¯å·®æ›´æ•æ„Ÿ
                                      # è¶Šå¤§: å¥–åŠ±å‡½æ•°è¶Šå¹³ç¼“ï¼Œæ›´å®¹å¿è¯¯å·®
    
    # === è½¯é™åˆ¶ç³»æ•° ===
    soft_dof_pos_limit = 0.95         # å…³èŠ‚ä½ç½®è½¯é™åˆ¶ (95% çš„ URDF é™åˆ¶)
    soft_dof_vel_limit = 0.95         # å…³èŠ‚é€Ÿåº¦è½¯é™åˆ¶
    soft_torque_limit = 0.95          # åŠ›çŸ©è½¯é™åˆ¶
    
    # === ç›®æ ‡å€¼ ===
    base_height_target = 0.30         # ç›®æ ‡èº«ä½“é«˜åº¦ (ç±³)
                                      # Aliengo çš„è‡ªç„¶ç«™ç«‹é«˜åº¦
    
    clearance_height_target = -0.20   # è¶³ç«¯æ‘†åŠ¨ç›¸ç›®æ ‡é«˜åº¦ (ç±³)
                                      # è´Ÿå€¼: åœ¨èº«ä½“åæ ‡ç³»ä¸‹æ–¹
                                      # è¡¨ç¤ºè¶³ç«¯åº”åœ¨èº«ä½“ä¸‹æ–¹ 0.20 ç±³
    
    # === é˜ˆå€¼å‚æ•° ===
    max_contact_force = 100.0         # æœ€å¤§å…è®¸æ¥è§¦åŠ› (ç‰›é¡¿)
                                      # è¶…è¿‡æ­¤å€¼å°†è¢«æƒ©ç½š
```

### æƒé‡é…ç½®å¯¹æ¯”è¡¨

| å¥–åŠ±é¡¹ | Aliengo | åŸºç¡€é…ç½® | å·®å¼‚è¯´æ˜ |
|-------|---------|---------|---------|
| tracking_lin_vel | 1.0 | 1.0 | ç›¸åŒ - ä¸»è¦è®­ç»ƒç›®æ ‡ |
| tracking_ang_vel | 0.5 | 0.5 | ç›¸åŒ - æ¬¡è¦ç›®æ ‡ |
| lin_vel_z | -2.0 | -2.0 | ç›¸åŒ - ç¨³å®šæ€§çº¦æŸ |
| ang_vel_xy | -0.05 | -0.05 | ç›¸åŒ |
| **orientation** | **-0.2** | **0.0** | **Aliengo å¯ç”¨å§¿æ€çº¦æŸ** |
| **base_height** | **-1.0** | **0.0** | **Aliengo å¼ºåˆ¶èº«é«˜æ§åˆ¶** |
| **joint_power** | **-2e-5** | **æœªå®šä¹‰** | **Aliengo å…³æ³¨èƒ½æ•ˆ** |
| **foot_clearance** | **-0.01** | **æœªå®šä¹‰** | **Aliengo ä¼˜åŒ–æ­¥æ€** |
| **action_rate** | -0.01 | -0.01 | ç›¸åŒ |
| **smoothness** | **-0.01** | **æœªå®šä¹‰** | **Aliengo è¦æ±‚æ›´é«˜å¹³æ»‘åº¦** |
| dof_acc | -2.5e-7 | -2.5e-7 | ç›¸åŒ |
| torques | 0.0 (ç¦ç”¨) | -0.00001 | Aliengo ä¾èµ– joint_power |
| feet_air_time | 0.0 (ç¦ç”¨) | 1.0 | Aliengo ä¸å¼ºåˆ¶æ­¥æ€å‘¨æœŸ |
| collision | 0.0 (ç¦ç”¨) | -1.0 | Aliengo åœ°å½¢è¾ƒç®€å• |

### é…ç½®ç­–ç•¥åˆ†æ

#### Aliengo çš„é…ç½®ç‰¹ç‚¹

1. **å¼ºè°ƒç¨³å®šæ€§**
   - å¯ç”¨ `orientation`(-0.2) å’Œ `base_height`(-1.0)
   - ä¿æŒèº«ä½“æ°´å¹³å’Œå›ºå®šé«˜åº¦

2. **å…³æ³¨è¿åŠ¨è´¨é‡**
   - æ·»åŠ  `smoothness`(-0.01) å’Œ `foot_clearance`(-0.01)
   - è¦æ±‚æ›´å¹³æ»‘çš„æ§åˆ¶å’Œæ›´å¥½çš„æ­¥æ€

3. **èƒ½æ•ˆä¼˜åŒ–**
   - ä½¿ç”¨ `joint_power`(-2e-5) è€Œé `torques`
   - è€ƒè™‘é€Ÿåº¦å’ŒåŠ›çŸ©çš„ç»¼åˆåŠŸç‡

4. **ç®€åŒ–ç¢°æ’æ£€æµ‹**
   - ç¦ç”¨ `collision` å’Œ `feet_stumble`
   - å¯èƒ½è®­ç»ƒç¯å¢ƒåœ°å½¢è¾ƒç®€å•

5. **è‡ªç”±æ­¥æ€**
   - ç¦ç”¨ `feet_air_time`
   - ä¸å¼ºåˆ¶ç‰¹å®šçš„æ­¥æ€å‘¨æœŸï¼Œè®©ç­–ç•¥è‡ªä¸»å­¦ä¹ 

#### åŸºç¡€é…ç½®çš„ç‰¹ç‚¹

1. **æœ€å°åŒ–é…ç½®**
   - ä»…å¯ç”¨æ ¸å¿ƒå¥–åŠ±é¡¹
   - é€‚åˆå¿«é€ŸåŸå‹å’Œåˆæ­¥æµ‹è¯•

2. **å¼ºåˆ¶æ­¥æ€**
   - å¯ç”¨ `feet_air_time`(1.0)
   - é¼“åŠ±ç‰¹å®šçš„æ­¥æ€å‘¨æœŸ

3. **ç¢°æ’æ£€æµ‹**
   - å¯ç”¨ `collision`(-1.0)
   - é€‚åˆå¤æ‚åœ°å½¢è®­ç»ƒ

### å‚æ•°è°ƒä¼˜å»ºè®®

#### tracking_sigma çš„å½±å“

```python
tracking_sigma = 0.25  # é»˜è®¤å€¼

# å¥–åŠ±æ›²çº¿ç¤ºä¾‹ (è¯¯å·® vs å¥–åŠ±):
# sigma = 0.10 (ä¸¥æ ¼):  è¯¯å·® 0.1 â†’ å¥–åŠ± 0.37,  è¯¯å·® 0.2 â†’ å¥–åŠ± 0.14
# sigma = 0.25 (é»˜è®¤):  è¯¯å·® 0.1 â†’ å¥–åŠ± 0.67,  è¯¯å·® 0.2 â†’ å¥–åŠ± 0.45
# sigma = 0.50 (å®½æ¾):  è¯¯å·® 0.1 â†’ å¥–åŠ± 0.82,  è¯¯å·® 0.2 â†’ å¥–åŠ± 0.67
```

**è°ƒä¼˜ç­–ç•¥ï¼š**
- è®­ç»ƒåˆæœŸï¼šä½¿ç”¨è¾ƒå¤§çš„ sigma (0.5)ï¼Œè®©ç­–ç•¥æ›´å®¹æ˜“è·å¾—å¥–åŠ±
- è®­ç»ƒä¸­æœŸï¼šä½¿ç”¨é»˜è®¤ sigma (0.25)
- è®­ç»ƒåæœŸï¼šé€æ¸å‡å° sigma (0.1-0.15)ï¼Œæé«˜ç²¾åº¦è¦æ±‚

#### æƒé‡å¹³è¡¡åŸåˆ™

```
æ€»å¥–åŠ± = Î£(w_i Ã— r_i)

å¹³è¡¡ç›®æ ‡:
1. æ­£å¥–åŠ±æ€»å’Œ â‰ˆ è´Ÿå¥–åŠ±æ€»å’Œ (åœ¨æœŸæœ›è¡Œä¸ºä¸‹)
2. ä¸»è¦ç›®æ ‡æƒé‡ >> æ¬¡è¦ç›®æ ‡æƒé‡
3. æƒ©ç½šé¡¹æƒé‡é¿å…è¿‡å¤§ï¼Œé˜²æ­¢è¿‡æ—©ç»ˆæ­¢è®­ç»ƒ

ç¤ºä¾‹ (æœŸæœ›è¡Œä¸ºä¸‹çš„å¥–åŠ±):
  tracking_lin_vel:  1.0 Ã— 0.8 = +0.8
  tracking_ang_vel:  0.5 Ã— 0.7 = +0.35
  è´Ÿå¥–åŠ±æ€»å’Œ:                  â‰ˆ -0.5 to -0.8
  æ€»å¥–åŠ±:                      â‰ˆ +0.4 to +0.7 (æ­£å€¼)
```

#### å¸¸è§é…ç½®æ¨¡å¼

**1. é€Ÿåº¦ä¼˜å…ˆæ¨¡å¼**
```python
tracking_lin_vel = 2.0   # å¢å¤§
tracking_ang_vel = 1.0   # å¢å¤§
å…¶ä»–æƒ©ç½šé¡¹ = è¾ƒå°å€¼        # å‡å°æƒ©ç½š
```
- é€‚ç”¨åœºæ™¯ï¼šå¿«é€Ÿç§»åŠ¨ä»»åŠ¡
- ç¼ºç‚¹ï¼šå¯èƒ½ç‰ºç‰²ç¨³å®šæ€§

**2. ç¨³å®šæ€§ä¼˜å…ˆæ¨¡å¼**
```python
tracking_lin_vel = 0.5   # å‡å°
orientation = -0.5       # å¢å¤§æƒ©ç½š
base_height = -2.0       # å¢å¤§æƒ©ç½š
ang_vel_xy = -0.1        # å¢å¤§æƒ©ç½š
```
- é€‚ç”¨åœºæ™¯ï¼šç²¾ç¡®å®šä½ã€å¤æ‚åœ°å½¢
- ç¼ºç‚¹ï¼šç§»åŠ¨é€Ÿåº¦å¯èƒ½è¾ƒæ…¢

**3. èƒ½æ•ˆä¼˜å…ˆæ¨¡å¼**
```python
joint_power = -5e-5      # å¢å¤§æƒ©ç½š
torques = -0.0001        # å¯ç”¨
action_rate = -0.02      # å¢å¤§æƒ©ç½š
```
- é€‚ç”¨åœºæ™¯ï¼šé•¿æ—¶é—´è¿è¡Œã€ç”µæ± ä¾›ç”µ
- ç¼ºç‚¹ï¼šåŠ¨æ€æ€§èƒ½å¯èƒ½é™ä½

**4. å¹³æ»‘æ§åˆ¶æ¨¡å¼**
```python
action_rate = -0.05      # å¤§å¹…å¢åŠ 
smoothness = -0.05       # å¤§å¹…å¢åŠ 
dof_acc = -1e-6          # å¢å¤§æƒ©ç½š
```
- é€‚ç”¨åœºæ™¯ï¼šå®é™…æœºå™¨äººéƒ¨ç½²
- ä¼˜ç‚¹ï¼šå‡å°‘æœºæ¢°ç£¨æŸï¼Œæé«˜å®‰å…¨æ€§

---

## å¥–åŠ±å‡½æ•°è®¡ç®—æµç¨‹è¯¦è§£

### 1. åˆå§‹åŒ–é˜¶æ®µ

```python
def _prepare_reward_function(self):
    # 1. ç§»é™¤æƒé‡ä¸º 0 çš„å¥–åŠ±é¡¹
    for key in list(self.reward_scales.keys()):
        if self.reward_scales[key] == 0:
            self.reward_scales.pop(key)
        else:
            # 2. å°†æƒé‡ä¹˜ä»¥æ—¶é—´æ­¥é•¿
            self.reward_scales[key] *= self.dt  # dt = 0.005
    
    # 3. åˆ›å»ºå¥–åŠ±å‡½æ•°åˆ—è¡¨
    self.reward_functions = []
    self.reward_names = []
    for name, scale in self.reward_scales.items():
        if name == "termination":
            continue
        self.reward_names.append(name)
        self.reward_functions.append(getattr(self, '_reward_' + name))
    
    # 4. åˆå§‹åŒ– episode ç´¯è®¡å¥–åŠ±
    self.episode_sums = {name: torch.zeros(self.num_envs, ...) 
                         for name in self.reward_scales.keys()}
```

### 2. æ¯ä¸ªæ—¶é—´æ­¥çš„å¥–åŠ±è®¡ç®—

```python
def compute_reward(self):
    self.rew_buf[:] = 0.
    
    # 1. éå†æ‰€æœ‰æ¿€æ´»çš„å¥–åŠ±å‡½æ•°
    for i in range(len(self.reward_functions)):
        name = self.reward_names[i]
        # 2. è®¡ç®—åŸå§‹å¥–åŠ±
        raw_reward = self.reward_functions[i]()
        # 3. ä¹˜ä»¥æƒé‡ç³»æ•°
        scaled_reward = raw_reward * self.reward_scales[name]
        # 4. ç´¯åŠ åˆ°æ€»å¥–åŠ±
        self.rew_buf += scaled_reward
        # 5. ç´¯åŠ åˆ° episode ç»Ÿè®¡
        self.episode_sums[name] += scaled_reward
    
    # 6. å¯é€‰ï¼šè£å‰ªè´Ÿå¥–åŠ±
    if self.cfg.rewards.only_positive_rewards:
        self.rew_buf[:] = torch.clip(self.rew_buf[:], min=0.)
    
    # 7. æ·»åŠ ç»ˆæ­¢å¥–åŠ±ï¼ˆåœ¨è£å‰ªä¹‹åï¼‰
    if "termination" in self.reward_scales:
        rew = self._reward_termination() * self.reward_scales["termination"]
        self.rew_buf += rew
        self.episode_sums["termination"] += rew
```

### 3. Episode ç»“æŸæ—¶çš„ç»Ÿè®¡

æ¯å½“ç¯å¢ƒé‡ç½®æ—¶ï¼Œç³»ç»Ÿä¼šè®°å½•å¹¶æŠ¥å‘Šè¯¥ episode çš„ç´¯è®¡å¥–åŠ±ï¼š

```python
def reset_idx(self, env_ids):
    # ... é‡ç½®é€»è¾‘ ...
    
    # è®°å½• episode å¥–åŠ±ä¿¡æ¯
    if self.cfg.env.send_episode_info:
        self.extras["episode"] = {}
        for key in self.episode_sums.keys():
            self.extras["episode"]['rew_' + key] = \
                torch.mean(self.episode_sums[key][env_ids]) / self.max_episode_length
        
        # é‡ç½®ç´¯è®¡å€¼
        for key in self.episode_sums.keys():
            self.episode_sums[key][env_ids] = 0.
```

---

## å¥–åŠ±è®¾è®¡çš„å…³é”®è€ƒè™‘

### 1. æƒé‡å¹³è¡¡

- **ä¸»è¦ç›®æ ‡**ï¼ˆæƒé‡è¾ƒå¤§ï¼‰ï¼š
  - `tracking_lin_vel`: 1.0
  - `tracking_ang_vel`: 0.5
  - `base_height`: -1.0

- **æ¬¡è¦ç›®æ ‡**ï¼ˆæƒé‡è¾ƒå°ï¼‰ï¼š
  - `lin_vel_z`: -2.0
  - `orientation`: -0.2
  - `action_rate`: -0.01

- **å¾®è°ƒé¡¹**ï¼ˆæƒé‡æå°ï¼‰ï¼š
  - `dof_acc`: -2.5e-7
  - `joint_power`: -2e-5

### 2. æ­£è´Ÿå¥–åŠ±æ¯”ä¾‹

- **æ­£å¥–åŠ±**ï¼šä¸»è¦æ¥è‡ªé€Ÿåº¦è·Ÿè¸ª
- **è´Ÿå¥–åŠ±**ï¼šæ¥è‡ªçº¦æŸè¿åå’Œä¸æœŸæœ›è¡Œä¸º
- Aliengo é…ç½®ä¸­ `only_positive_rewards = False`ï¼Œå…è®¸è´Ÿæ€»å¥–åŠ±

### 3. æ—¶é—´å½’ä¸€åŒ–

æ‰€æœ‰å¥–åŠ±æƒé‡éƒ½ä¼šä¹˜ä»¥æ—¶é—´æ­¥é•¿ `dt = 0.005`ï¼Œè¿™æ ·ï¼š
- å¥–åŠ±å¤§å°ä¸æ§åˆ¶é¢‘ç‡æ— å…³
- ä¾¿äºåœ¨ä¸åŒé¢‘ç‡ä¸‹è¿ç§»ç­–ç•¥

### 4. å¥–åŠ±ç¨€ç–æ€§

- é€šè¿‡è®¾ç½®æƒé‡ä¸º 0 æ¥ç¦ç”¨ä¸éœ€è¦çš„å¥–åŠ±é¡¹
- å‡å°‘è®¡ç®—å¼€é”€
- ç®€åŒ–è®­ç»ƒè¿‡ç¨‹

---

---

## è°ƒè¯•å’Œè°ƒä¼˜æŒ‡å—

### å¥–åŠ±ç›‘æ§å’Œåˆ†æ

#### 1. Episode å¥–åŠ±æ—¥å¿—

è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªepisodeç»“æŸæ—¶ä¼šè®°å½•å„é¡¹å¥–åŠ±çš„å¹³å‡å€¼ï¼š

```python
# æ—¥å¿—è¾“å‡ºç¤ºä¾‹
Episode rewards:
  rew_tracking_lin_vel: 0.8234
  rew_tracking_ang_vel: 0.6421
  rew_lin_vel_z: -0.0123
  rew_ang_vel_xy: -0.0045
  rew_orientation: -0.0234
  rew_base_height: -0.0567
  rew_joint_power: -0.0012
  rew_action_rate: -0.0089
  rew_smoothness: -0.0076
  rew_dof_acc: -0.0003
  rew_foot_clearance: -0.0034
  Total reward: 1.3472
```

#### 2. å¥–åŠ±åˆ†æå·¥å…·

**æŸ¥çœ‹å¥–åŠ±è¶‹åŠ¿ï¼š**
```python
# åœ¨è®­ç»ƒæ—¥å¿—ä¸­æŸ¥æ‰¾
grep "rew_tracking_lin_vel" logs/rough_aliengo/*/summaries.txt

# ä½¿ç”¨ TensorBoard å¯è§†åŒ–
tensorboard --logdir logs/rough_aliengo/
```

**åˆ†æå¥–åŠ±æƒé‡æ˜¯å¦åˆç†ï¼š**
```python
# è®¡ç®—å„é¡¹å¥–åŠ±å æ¯”
positive_rewards = rew_tracking_lin_vel + rew_tracking_ang_vel
negative_rewards = sum(æ‰€æœ‰è´Ÿå¥–åŠ±çš„ç»å¯¹å€¼)
ratio = positive_rewards / negative_rewards

# ç†æƒ³æ¯”ä¾‹: 1.5 - 3.0
# æ¯”ä¾‹è¿‡å¤§: æƒ©ç½šè¿‡è½»ï¼Œå¯èƒ½å¯¼è‡´ä¸è‰¯è¡Œä¸º
# æ¯”ä¾‹è¿‡å°: æƒ©ç½šè¿‡é‡ï¼Œå¯èƒ½å¯¼è‡´æ¶ˆæç­–ç•¥
```

### å¸¸è§é—®é¢˜è¯Šæ–­

#### é—®é¢˜ 1: æœºå™¨äººä¸ç§»åŠ¨æˆ–ç§»åŠ¨ç¼“æ…¢

**ç—‡çŠ¶ï¼š**
- `rew_tracking_lin_vel` å¾ˆä½ (< 0.3)
- æœºå™¨äººåŸåœ°ä¸åŠ¨æˆ–ç§»åŠ¨å¾ˆæ…¢

**å¯èƒ½åŸå› ï¼š**
1. é€Ÿåº¦è·Ÿè¸ªå¥–åŠ±æƒé‡è¿‡å°
2. æƒ©ç½šé¡¹è¿‡å¼ºï¼ŒæŠ‘åˆ¶äº†è¿åŠ¨
3. `stand_still` æœªæ­£ç¡®é…ç½®

**è¯Šæ–­æ­¥éª¤ï¼š**
```python
# æ£€æŸ¥å¥–åŠ±æƒé‡
print(f"tracking_lin_vel weight: {cfg.rewards.scales.tracking_lin_vel}")
print(f"Total negative weights: {sum(negative_weights)}")

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦æ­£ç¡®
print(f"Command velocity: {env.commands[0, :2]}")  # åº”è¯¥éé›¶

# æ£€æŸ¥å®é™…é€Ÿåº¦
print(f"Actual velocity: {env.base_lin_vel[0, :2]}")
```

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆ 1: å¢å¤§é€Ÿåº¦è·Ÿè¸ªæƒé‡
cfg.rewards.scales.tracking_lin_vel = 2.0  # ä» 1.0 å¢åŠ åˆ° 2.0

# æ–¹æ¡ˆ 2: å‡å°æƒ©ç½šé¡¹æƒé‡
cfg.rewards.scales.base_height = -0.5  # ä» -1.0 å‡å°
cfg.rewards.scales.orientation = -0.1  # ä» -0.2 å‡å°

# æ–¹æ¡ˆ 3: ç¡®ä¿ stand_still æ­£ç¡®é…ç½®
cfg.rewards.scales.stand_still = -0.0  # ç¦ç”¨ï¼Œæˆ–ä»…åœ¨é›¶å‘½ä»¤æ—¶å¯ç”¨
```

---

#### é—®é¢˜ 2: æœºå™¨äººè¿åŠ¨ä¸ç¨³å®šï¼ˆæŠ–åŠ¨ã€æ‘”å€’ï¼‰

**ç—‡çŠ¶ï¼š**
- `rew_orientation` å¾ˆè´Ÿ (< -0.5)
- `rew_ang_vel_xy` å¾ˆè´Ÿ
- Episode é¢‘ç¹ç»ˆæ­¢

**å¯èƒ½åŸå› ï¼š**
1. ç¨³å®šæ€§æƒ©ç½šæƒé‡è¿‡å°
2. é€Ÿåº¦è·Ÿè¸ªæƒé‡è¿‡å¤§ï¼Œç‰ºç‰²ç¨³å®šæ€§
3. åŠ¨ä½œå¹³æ»‘åº¦æƒ©ç½šä¸è¶³

**è¯Šæ–­æ­¥éª¤ï¼š**
```python
# æ£€æŸ¥å§¿æ€åå·®
print(f"Projected gravity: {env.projected_gravity[0]}")
# ç†æƒ³: [0, 0, -9.81]ï¼Œxå’Œyåº”æ¥è¿‘0

# æ£€æŸ¥è§’é€Ÿåº¦
print(f"Angular velocity: {env.base_ang_vel[0]}")
# rollå’Œpitch ([:2]) åº”è¯¥å¾ˆå°

# æ£€æŸ¥åŠ¨ä½œå˜åŒ–
print(f"Action change: {torch.norm(env.actions - env.last_actions, dim=1).mean()}")
```

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆ 1: å¢å¼ºç¨³å®šæ€§çº¦æŸ
cfg.rewards.scales.orientation = -0.5  # ä» -0.2 å¢åŠ åˆ° -0.5
cfg.rewards.scales.ang_vel_xy = -0.1   # ä» -0.05 å¢åŠ 
cfg.rewards.scales.base_height = -2.0  # å¢åŠ èº«é«˜çº¦æŸ

# æ–¹æ¡ˆ 2: å¢åŠ åŠ¨ä½œå¹³æ»‘åº¦
cfg.rewards.scales.action_rate = -0.05   # ä» -0.01 å¢åŠ 
cfg.rewards.scales.smoothness = -0.05
cfg.rewards.scales.dof_acc = -1e-6      # ä» -2.5e-7 å¢åŠ 

# æ–¹æ¡ˆ 3: é™ä½é€Ÿåº¦è·Ÿè¸ªè¦æ±‚
cfg.rewards.scales.tracking_lin_vel = 0.5  # ä¸´æ—¶é™ä½
cfg.rewards.tracking_sigma = 0.5           # æ”¾å®½å®¹å¿åº¦
```

---

#### é—®é¢˜ 3: åŠ¨ä½œæŠ–åŠ¨æ˜æ˜¾

**ç—‡çŠ¶ï¼š**
- å…³èŠ‚è¿åŠ¨ä¸å¹³æ»‘
- `rew_action_rate` å¾ˆè´Ÿ (< -0.5)
- `rew_smoothness` å¾ˆè´Ÿ

**å¯èƒ½åŸå› ï¼š**
1. åŠ¨ä½œå¹³æ»‘åº¦æƒ©ç½šä¸è¶³
2. è§‚æµ‹å™ªå£°è¿‡å¤§
3. ç½‘ç»œè¾“å‡ºä¸ç¨³å®š

**è¯Šæ–­æ­¥éª¤ï¼š**
```python
# æ£€æŸ¥åŠ¨ä½œæ–¹å·®
action_std = torch.std(env.actions, dim=0)
print(f"Action std: {action_std.mean()}")

# æ£€æŸ¥åŠ¨ä½œå˜åŒ–ç‡
action_change = torch.abs(env.actions - env.last_actions)
print(f"Mean action change: {action_change.mean()}")
print(f"Max action change: {action_change.max()}")

# å¯è§†åŒ–åŠ¨ä½œåºåˆ—
import matplotlib.pyplot as plt
plt.plot(action_history[:, 0])  # ç»˜åˆ¶ç¬¬ä¸€ä¸ªå…³èŠ‚çš„åŠ¨ä½œ
plt.title("Joint 0 Action Over Time")
plt.show()
```

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆ 1: å¤§å¹…å¢åŠ å¹³æ»‘åº¦æƒ©ç½š
cfg.rewards.scales.action_rate = -0.1    # å¤§å¹…å¢åŠ 
cfg.rewards.scales.smoothness = -0.1
cfg.rewards.scales.dof_acc = -5e-6

# æ–¹æ¡ˆ 2: å‡å°‘è§‚æµ‹å™ªå£°
cfg.noise.add_noise = False  # è®­ç»ƒåæœŸå…³é—­å™ªå£°
# æˆ–
cfg.noise.noise_level = 0.5  # ä» 1.0 å‡å°

# æ–¹æ¡ˆ 3: è°ƒæ•´ç½‘ç»œæ¶æ„
# åœ¨è®­ç»ƒé…ç½®ä¸­å¢åŠ ç½‘ç»œéšè—å±‚æˆ–ä½¿ç”¨ LSTM
cfg.policy.hidden_dims = [512, 256, 128]  # æ›´æ·±çš„ç½‘ç»œ
```

---

#### é—®é¢˜ 4: èƒ½è€—è¿‡é«˜

**ç—‡çŠ¶ï¼š**
- `rew_joint_power` å¾ˆè´Ÿ (< -1.0)
- å®é™…éƒ¨ç½²æ—¶ç”µæ± æ¶ˆè€—å¿«
- å…³èŠ‚æ¸©åº¦è¿‡é«˜

**å¯èƒ½åŸå› ï¼š**
1. èƒ½æ•ˆæƒ©ç½šæƒé‡è¿‡å°
2. åŠ¨ä½œå¹…åº¦è¿‡å¤§
3. æ²¡æœ‰è€ƒè™‘åŠ›çŸ©é™åˆ¶

**è¯Šæ–­æ­¥éª¤ï¼š**
```python
# æ£€æŸ¥å¹³å‡åŠŸç‡
power = torch.sum(torch.abs(env.dof_vel) * torch.abs(env.torques), dim=1)
print(f"Average power: {power.mean()} W")

# æ£€æŸ¥åŠ›çŸ©åˆ†å¸ƒ
print(f"Mean torque: {torch.abs(env.torques).mean()}")
print(f"Max torque: {torch.abs(env.torques).max()}")

# æ£€æŸ¥å…³èŠ‚é€Ÿåº¦
print(f"Mean joint velocity: {torch.abs(env.dof_vel).mean()} rad/s")
```

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆ 1: å¢å¼ºèƒ½æ•ˆæƒ©ç½š
cfg.rewards.scales.joint_power = -1e-4   # ä» -2e-5 å¢åŠ 
cfg.rewards.scales.torques = -0.0001     # å¯ç”¨åŠ›çŸ©æƒ©ç½š
cfg.rewards.scales.dof_vel = -0.001      # å¯ç”¨é€Ÿåº¦æƒ©ç½š

# æ–¹æ¡ˆ 2: é™åˆ¶åŠ¨ä½œèŒƒå›´
cfg.control.action_scale = 0.25  # ä» 0.5 å‡å°

# æ–¹æ¡ˆ 3: å¯ç”¨åŠ›çŸ©é™åˆ¶æƒ©ç½š
cfg.rewards.scales.torque_limits = -0.1
cfg.rewards.soft_torque_limit = 0.8  # ä½¿ç”¨ 80% çš„é™åˆ¶

# æ–¹æ¡ˆ 4: é™ä½é€Ÿåº¦è¦æ±‚
# åœ¨å‘½ä»¤é‡‡æ ·ä¸­é™ä½é€Ÿåº¦èŒƒå›´
cfg.commands.ranges.lin_vel_x = [-0.8, 0.8]  # ä» [-1.0, 1.0] å‡å°
```

---

#### é—®é¢˜ 5: æ­¥æ€ä¸è‡ªç„¶ï¼ˆæ‹–è„šã€é«˜æŠ¬è…¿ï¼‰

**ç—‡çŠ¶ï¼š**
- è¶³ç«¯æ¥è§¦åœ°é¢æ—¶æ‹–åŠ¨
- æˆ–è¶³ç«¯æŠ¬å¾—è¿‡é«˜
- `rew_foot_clearance` å¼‚å¸¸

**å¯èƒ½åŸå› ï¼š**
1. `clearance_height_target` è®¾ç½®ä¸å½“
2. `foot_clearance` æƒé‡ä¸åˆé€‚
3. ç¼ºå°‘è¶³ç«¯æ»ç©ºæ—¶é—´çº¦æŸ

**è¯Šæ–­æ­¥éª¤ï¼š**
```python
# æ£€æŸ¥è¶³ç«¯é«˜åº¦ï¼ˆåœ¨èº«ä½“åæ ‡ç³»ï¼‰
foot_heights = env.feet_pos[:, :, 2] - env.root_states[:, 2].unsqueeze(1)
print(f"Foot heights: {foot_heights[0]}")

# æ£€æŸ¥è¶³ç«¯é€Ÿåº¦
foot_vel = env.feet_vel
print(f"Foot velocities: {torch.norm(foot_vel[0], dim=-1)}")

# æ£€æŸ¥æ»ç©ºæ—¶é—´
print(f"Air time: {env.feet_air_time[0]}")
```

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆ 1: è°ƒæ•´ç›®æ ‡é«˜åº¦
# æ‹–è„šé—®é¢˜ - æé«˜ç›®æ ‡
cfg.rewards.clearance_height_target = -0.15  # ä» -0.20 æé«˜

# é«˜æŠ¬è…¿é—®é¢˜ - é™ä½ç›®æ ‡
cfg.rewards.clearance_height_target = -0.25  # ä» -0.20 é™ä½

# æ–¹æ¡ˆ 2: è°ƒæ•´æƒ©ç½šæƒé‡
cfg.rewards.scales.foot_clearance = -0.02  # å¢åŠ æƒé‡

# æ–¹æ¡ˆ 3: å¯ç”¨æ»ç©ºæ—¶é—´çº¦æŸ
cfg.rewards.scales.feet_air_time = 0.5  # é¼“åŠ±æ­£å¸¸æ­¥æ€å‘¨æœŸ

# æ–¹æ¡ˆ 4: æ£€æŸ¥åœ°å½¢è®¾ç½®
cfg.terrain.mesh_type = 'plane'  # å…ˆåœ¨å¹³åœ°æµ‹è¯•
```

---

### æ¸è¿›å¼è®­ç»ƒç­–ç•¥

#### è¯¾ç¨‹å­¦ä¹ ï¼ˆCurriculum Learningï¼‰

ä½¿ç”¨åŠ¨æ€è°ƒæ•´çš„å¥–åŠ±æƒé‡ï¼Œä»ç®€å•åˆ°å¤æ‚ï¼š

**é˜¶æ®µ 1: åŸºç¡€è¿åŠ¨ (0-2M steps)**
```python
# ä¸“æ³¨äºé€Ÿåº¦è·Ÿè¸ªå’ŒåŸºæœ¬ç¨³å®šæ€§
rewards.scales.tracking_lin_vel = 2.0   # é«˜æƒé‡
rewards.scales.tracking_ang_vel = 1.0
rewards.scales.orientation = -0.1       # ä½æƒ©ç½š
rewards.scales.base_height = -0.5
# å…¶ä»–æƒ©ç½šé¡¹ä½¿ç”¨è¾ƒå°æƒé‡
```

**é˜¶æ®µ 2: ç¨³å®šæ€§ä¼˜åŒ– (2M-5M steps)**
```python
# é€æ¸å¢åŠ ç¨³å®šæ€§è¦æ±‚
rewards.scales.tracking_lin_vel = 1.5   # ç•¥å¾®é™ä½
rewards.scales.orientation = -0.2       # å¢åŠ 
rewards.scales.base_height = -1.0       # å¢åŠ 
rewards.scales.action_rate = -0.01      # å¯ç”¨å¹³æ»‘åº¦
```

**é˜¶æ®µ 3: è¿åŠ¨è´¨é‡ (5M-10M steps)**
```python
# ä¼˜åŒ–è¿åŠ¨è´¨é‡å’Œèƒ½æ•ˆ
rewards.scales.tracking_lin_vel = 1.0   # æ ‡å‡†æƒé‡
rewards.scales.joint_power = -2e-5      # å¯ç”¨èƒ½æ•ˆ
rewards.scales.smoothness = -0.01       # å¯ç”¨äºŒé˜¶å¹³æ»‘
rewards.scales.foot_clearance = -0.01   # ä¼˜åŒ–æ­¥æ€
```

**é˜¶æ®µ 4: ç²¾ç»†è°ƒä¼˜ (10M+ steps)**
```python
# ä¸¥æ ¼çº¦æŸï¼Œæ¥è¿‘å®é™…éƒ¨ç½²è¦æ±‚
rewards.tracking_sigma = 0.15           # å‡å°å®¹å¿åº¦
rewards.scales.action_rate = -0.02      # å¢å¼ºå¹³æ»‘åº¦
# æ ¹æ®å®é™…è¡¨ç°å¾®è°ƒå…¶ä»–æƒé‡
```

**å®ç°è¯¾ç¨‹å­¦ä¹ ï¼š**
```python
def update_reward_scales(iteration, cfg):
    """æ ¹æ®è®­ç»ƒè¿­ä»£æ¬¡æ•°åŠ¨æ€è°ƒæ•´å¥–åŠ±æƒé‡"""
    if iteration < 2000:  # é˜¶æ®µ 1
        cfg.rewards.scales.tracking_lin_vel = 2.0
        cfg.rewards.scales.orientation = -0.1
    elif iteration < 5000:  # é˜¶æ®µ 2
        cfg.rewards.scales.tracking_lin_vel = 1.5
        cfg.rewards.scales.orientation = -0.2
    elif iteration < 10000:  # é˜¶æ®µ 3
        cfg.rewards.scales.tracking_lin_vel = 1.0
        cfg.rewards.scales.joint_power = -2e-5
    else:  # é˜¶æ®µ 4
        cfg.rewards.tracking_sigma = 0.15
        cfg.rewards.scales.action_rate = -0.02
```

---

### å¥–åŠ±æƒé‡æœç´¢

#### ç½‘æ ¼æœç´¢

å¯¹å…³é”®å‚æ•°è¿›è¡Œç½‘æ ¼æœç´¢ï¼š

```python
import itertools

# å®šä¹‰æœç´¢ç©ºé—´
param_grid = {
    'tracking_lin_vel': [0.5, 1.0, 2.0],
    'orientation': [-0.1, -0.2, -0.5],
    'action_rate': [-0.005, -0.01, -0.02]
}

# ç”Ÿæˆæ‰€æœ‰ç»„åˆ
keys = param_grid.keys()
combinations = list(itertools.product(*param_grid.values()))

# è®­ç»ƒæ¯ä¸ªé…ç½®
for combo in combinations:
    config = dict(zip(keys, combo))
    print(f"Training with: {config}")
    # è¿è¡Œè®­ç»ƒ...
    # è®°å½•æœ€ç»ˆæ€§èƒ½...
```

#### è´å¶æ–¯ä¼˜åŒ–

ä½¿ç”¨è´å¶æ–¯ä¼˜åŒ–æ›´é«˜æ•ˆåœ°æœç´¢ï¼š

```python
from ax import optimize

def train_and_evaluate(params):
    """è®­ç»ƒå¹¶è¿”å›æ€§èƒ½æŒ‡æ ‡"""
    cfg.rewards.scales.tracking_lin_vel = params['tracking_lin_vel']
    cfg.rewards.scales.orientation = params['orientation']
    # ... è®¾ç½®å…¶ä»–å‚æ•°
    
    # è®­ç»ƒ
    final_reward = train_policy(cfg)
    return final_reward

# å®šä¹‰æœç´¢ç©ºé—´
best_parameters, best_values, experiment, model = optimize(
    parameters=[
        {"name": "tracking_lin_vel", "type": "range", "bounds": [0.5, 2.0]},
        {"name": "orientation", "type": "range", "bounds": [-0.5, -0.1]},
        {"name": "action_rate", "type": "range", "bounds": [-0.05, -0.005]},
    ],
    evaluation_function=train_and_evaluate,
    objective_name="reward",
    total_trials=20
)
```

---

### å¯è§†åŒ–å’Œè°ƒè¯•å·¥å…·

#### 1. å®æ—¶å¥–åŠ±ç›‘æ§

```python
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation

def plot_rewards_realtime(log_file):
    """å®æ—¶ç»˜åˆ¶å¥–åŠ±æ›²çº¿"""
    fig, axes = plt.subplots(2, 2, figsize=(12, 8))
    
    def update(frame):
        # è¯»å–æœ€æ–°æ—¥å¿—
        rewards = parse_log(log_file)
        
        # ç»˜åˆ¶ä¸»è¦å¥–åŠ±
        axes[0, 0].clear()
        axes[0, 0].plot(rewards['tracking_lin_vel'])
        axes[0, 0].set_title('Linear Velocity Tracking')
        
        # ç»˜åˆ¶æƒ©ç½šé¡¹
        axes[0, 1].clear()
        axes[0, 1].plot(rewards['orientation'])
        axes[0, 1].set_title('Orientation Penalty')
        
        # ... æ›´å¤šå›¾è¡¨
    
    ani = FuncAnimation(fig, update, interval=1000)
    plt.show()
```

#### 2. å¥–åŠ±çƒ­åŠ›å›¾

```python
import seaborn as sns

def plot_reward_heatmap(episode_rewards):
    """ç»˜åˆ¶å„é¡¹å¥–åŠ±çš„ç›¸å…³æ€§çƒ­åŠ›å›¾"""
    reward_df = pd.DataFrame(episode_rewards)
    correlation = reward_df.corr()
    
    plt.figure(figsize=(10, 8))
    sns.heatmap(correlation, annot=True, cmap='coolwarm', center=0)
    plt.title('Reward Components Correlation')
    plt.show()
```

#### 3. 3D å¯è§†åŒ–

```python
def visualize_foot_clearance(env, robot_id=0):
    """å¯è§†åŒ–è¶³ç«¯è½¨è¿¹å’Œç›®æ ‡é«˜åº¦"""
    import matplotlib.pyplot as plt
    from mpl_toolkits.mplot3d import Axes3D
    
    foot_trajectory = []
    for _ in range(100):
        env.step(policy(env.obs))
        foot_trajectory.append(env.feet_pos[robot_id].cpu().numpy())
    
    fig = plt.figure()
    ax = fig.add_subplot(111, projection='3d')
    
    foot_trajectory = np.array(foot_trajectory)
    for foot_id in range(4):
        ax.plot(foot_trajectory[:, foot_id, 0],
                foot_trajectory[:, foot_id, 1],
                foot_trajectory[:, foot_id, 2],
                label=f'Foot {foot_id}')
    
    # ç»˜åˆ¶ç›®æ ‡é«˜åº¦å¹³é¢
    target_height = env.cfg.rewards.clearance_height_target
    xx, yy = np.meshgrid(range(-1, 2), range(-1, 2))
    zz = np.ones_like(xx) * target_height
    ax.plot_surface(xx, yy, zz, alpha=0.3, color='red')
    
    plt.legend()
    plt.show()
```

---

### æ€§èƒ½åŸºå‡†å’Œç›®æ ‡

#### è®­ç»ƒç›®æ ‡å€¼ï¼ˆAliengoï¼‰

```python
# Episode å¹³å‡å¥–åŠ±ç›®æ ‡
target_rewards = {
    'tracking_lin_vel': > 0.7,      # å¥½: >0.8, ä¼˜ç§€: >0.9
    'tracking_ang_vel': > 0.6,      # å¥½: >0.7, ä¼˜ç§€: >0.8
    'lin_vel_z': > -0.05,           # å¥½: >-0.02
    'ang_vel_xy': > -0.01,          # å¥½: >-0.005
    'orientation': > -0.05,         # å¥½: >-0.02
    'base_height': > -0.1,          # å¥½: >-0.05
    'joint_power': > -0.01,         # å¥½: >-0.005
    'action_rate': > -0.05,         # å¥½: >-0.02
    'smoothness': > -0.05,          # å¥½: >-0.02
    'dof_acc': < -0.001,            # (éå¸¸å°çš„è´Ÿå€¼)
    'foot_clearance': > -0.02,      # å¥½: >-0.01
    'total_reward': > 1.0,          # å¥½: >1.5, ä¼˜ç§€: >2.0
}
```

#### æ”¶æ•›æ ‡å‡†

```python
def check_convergence(rewards_history, window=100):
    """æ£€æŸ¥è®­ç»ƒæ˜¯å¦æ”¶æ•›"""
    recent = rewards_history[-window:]
    
    # 1. æ€»å¥–åŠ±ç¨³å®š
    reward_std = np.std(recent)
    reward_mean = np.mean(recent)
    cv = reward_std / reward_mean  # å˜å¼‚ç³»æ•°
    
    converged = cv < 0.1  # å˜å¼‚ç³»æ•° < 10%
    
    # 2. æ— æ˜æ˜¾ä¸Šå‡è¶‹åŠ¿
    from scipy.stats import linregress
    slope, _, _, _, _ = linregress(range(len(recent)), recent)
    stagnant = abs(slope) < 0.01
    
    # 3. è¾¾åˆ°ç›®æ ‡æ€§èƒ½
    performance_met = reward_mean > 1.0
    
    return converged and stagnant and performance_met
```

---

### æ€»ç»“ï¼šå¥–åŠ±å‡½æ•°è°ƒè¯•æ¸…å•

âœ… **è®­ç»ƒå‰æ£€æŸ¥ï¼š**
- [ ] ç¡®è®¤æ‰€æœ‰æƒé‡é…ç½®æ­£ç¡®
- [ ] éªŒè¯æƒé‡ç¬¦å·ï¼ˆæ­£/è´Ÿï¼‰æ­£ç¡®
- [ ] æ£€æŸ¥ `only_positive_rewards` è®¾ç½®
- [ ] ç¡®è®¤ `tracking_sigma` å€¼åˆç†
- [ ] éªŒè¯ç›®æ ‡å€¼ï¼ˆèº«é«˜ã€ç¦»åœ°é«˜åº¦ï¼‰ç¬¦åˆæœºå™¨äººè§„æ ¼

âœ… **è®­ç»ƒä¸­ç›‘æ§ï¼š**
- [ ] å®æ—¶æŸ¥çœ‹æ€»å¥–åŠ±è¶‹åŠ¿
- [ ] ç›‘æ§å„é¡¹å¥–åŠ±å æ¯”
- [ ] æ£€æŸ¥æ­£è´Ÿå¥–åŠ±å¹³è¡¡
- [ ] è§‚å¯ŸEpisodeæˆåŠŸç‡
- [ ] è®°å½•å¼‚å¸¸è¡Œä¸ºå’Œå¯¹åº”å¥–åŠ±

âœ… **è®­ç»ƒååˆ†æï¼š**
- [ ] å¯¹æ¯”ç›®æ ‡å¥–åŠ±å€¼
- [ ] åˆ†æå¥–åŠ±ç›¸å…³æ€§
- [ ] å¯è§†åŒ–è¶³ç«¯è½¨è¿¹
- [ ] æµ‹è¯•ä¸åŒé€Ÿåº¦å‘½ä»¤
- [ ] éªŒè¯å®é™…éƒ¨ç½²æ€§èƒ½

âœ… **é—®é¢˜å®šä½ï¼š**
- [ ] ä¸ç§»åŠ¨ â†’ æ£€æŸ¥é€Ÿåº¦è·Ÿè¸ªæƒé‡
- [ ] ä¸ç¨³å®š â†’ å¢å¼ºç¨³å®šæ€§çº¦æŸ
- [ ] æŠ–åŠ¨ â†’ å¢åŠ å¹³æ»‘åº¦æƒ©ç½š
- [ ] è€—èƒ½é«˜ â†’ å¯ç”¨èƒ½æ•ˆæƒ©ç½š
- [ ] æ­¥æ€å·® â†’ è°ƒæ•´è¶³ç«¯çº¦æŸ

---

## é™„å½•

---

---

### 12. torques - åŠ›çŸ©æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1167-1169 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_torques(self):
    # Penalize torques
    return torch.sum(torch.square(self.torques), dim=1)
```

#### é€è¡Œè§£é‡Š

```python
return torch.sum(torch.square(self.torques), dim=1)
```
- `self.torques`ï¼šå½“å‰æ‰€æœ‰å…³èŠ‚çš„åŠ›çŸ©ï¼Œå½¢çŠ¶ `[num_envs, num_dof]`
- `torch.square(...)`ï¼šå¯¹æ¯ä¸ªå…³èŠ‚åŠ›çŸ©å–å¹³æ–¹
- `torch.sum(..., dim=1)`ï¼šå¯¹æ‰€æœ‰å…³èŠ‚æ±‚å’Œ
- æ•°å­¦å…¬å¼ï¼š$\sum_i Ï„_i^2$
- ç›´æ¥æƒ©ç½šåŠ›çŸ©çš„å¤§å°ï¼Œä¸é€Ÿåº¦æ— å…³ï¼ˆåŒºåˆ«äº `joint_power`ï¼‰
- é˜²æ­¢ç”µæœºè¿‡è½½ï¼Œä¿æŠ¤ç¡¬ä»¶

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`-0.00001` (åŸºç¡€) / `-0.0` (Aliengo ç¦ç”¨)
- é€‚ç”¨åœºæ™¯ï¼šéœ€è¦ä¿æŠ¤ç¡¬ä»¶çš„åœºæ™¯

---

### 13. dof_vel - å…³èŠ‚é€Ÿåº¦æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1171-1173 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_dof_vel(self):
    # Penalize dof velocities
    return torch.sum(torch.square(self.dof_vel), dim=1)
```

#### é€è¡Œè§£é‡Š

```python
return torch.sum(torch.square(self.dof_vel), dim=1)
```
- `self.dof_vel`ï¼šå½“å‰æ‰€æœ‰å…³èŠ‚çš„é€Ÿåº¦ï¼Œå½¢çŠ¶ `[num_envs, num_dof]`
- è®¡ç®—ï¼š$\sum_i Ï‰_i^2$
- ç›´æ¥æƒ©ç½šå…³èŠ‚é€Ÿåº¦ï¼Œé˜²æ­¢é«˜é€Ÿè¿åŠ¨
- æœ‰åŠ©äºå»¶é•¿æœºæ¢°å¯¿å‘½å’Œæé«˜æ§åˆ¶ç¨³å®šæ€§

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`-0.0` (é€šå¸¸ç¦ç”¨)
- é€‚ç”¨åœºæ™¯ï¼šéœ€è¦ä½é€Ÿè¿åŠ¨çš„ç‰¹å®šä»»åŠ¡

---

### 14. collision - ç¢°æ’æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1175-1177 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_collision(self):
    # Penalize collisions on selected bodies
    return torch.sum(1.*(torch.norm(self.contact_forces[:, self.penalised_contact_indices, :], dim=-1) > 0.1), dim=1)
```

#### é€è¡Œè§£é‡Š

```python
return torch.sum(1.*(torch.norm(self.contact_forces[:, self.penalised_contact_indices, :], dim=-1) > 0.1), dim=1)
```
- `self.contact_forces`ï¼šæ‰€æœ‰åˆšä½“çš„æ¥è§¦åŠ›ï¼Œå½¢çŠ¶ `[num_envs, num_bodies, 3]`
- `self.penalised_contact_indices`ï¼šéœ€è¦æ£€æµ‹ç¢°æ’çš„èº«ä½“éƒ¨ä½ç´¢å¼•ï¼ˆå¦‚æœºèº«ã€å¤§è…¿ï¼‰
- `[:, self.penalised_contact_indices, :]`ï¼šæå–ç‰¹å®šéƒ¨ä½çš„æ¥è§¦åŠ›
- `torch.norm(..., dim=-1)`ï¼šè®¡ç®—æ¥è§¦åŠ›çš„æ¨¡ï¼ˆå¤§å°ï¼‰ï¼Œå½¢çŠ¶ `[num_envs, num_penalised_bodies]`
- `> 0.1`ï¼šå¸ƒå°”æ©ç ï¼Œæ¥è§¦åŠ›å¤§äº 0.1 N æ—¶ä¸º True
- `1.*`ï¼šå°†å¸ƒå°”å€¼è½¬æ¢ä¸ºæµ®ç‚¹æ•°ï¼ˆTrueâ†’1.0, Falseâ†’0.0ï¼‰
- `torch.sum(..., dim=1)`ï¼šç»Ÿè®¡æ¯ä¸ªç¯å¢ƒä¸­æœ‰å¤šå°‘ä¸ªèº«ä½“éƒ¨ä½å‘ç”Ÿç¢°æ’
- **æƒ©ç½šç‰¹æ€§ï¼š** ç¢°æ’çš„èº«ä½“éƒ¨ä½è¶Šå¤šï¼Œæƒ©ç½šè¶Šå¤§

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`-1.0` (åŸºç¡€) / `-0.0` (Aliengo ç¦ç”¨)
- é˜ˆå€¼ï¼š0.1 N
- é€‚ç”¨åœºæ™¯ï¼šé¿å…æœºå™¨äººèº«ä½“ä¸åœ°é¢æˆ–éšœç¢ç‰©ç¢°æ’

**ç¢°æ’æ£€æµ‹ç¤ºä¾‹ï¼š**
```
ç¯å¢ƒ1: æœºèº«æ¥è§¦åŠ› = 5 N, å·¦å¤§è…¿æ¥è§¦åŠ› = 0 N
      â†’ ç¢°æ’è®¡æ•° = 1, æƒ©ç½š = -1.0
ç¯å¢ƒ2: æ— éè¶³ç«¯æ¥è§¦
      â†’ ç¢°æ’è®¡æ•° = 0, æƒ©ç½š = 0
```

---

### 15. termination - ç»ˆæ­¢æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1179-1181 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_termination(self):
    # Terminal reward / penalty
    return self.reset_buf * ~self.time_out_buf
```

#### é€è¡Œè§£é‡Š

```python
return self.reset_buf * ~self.time_out_buf
```
- `self.reset_buf`ï¼šå¸ƒå°”å¼ é‡ï¼Œæ ‡è®°å“ªäº›ç¯å¢ƒéœ€è¦é‡ç½®ï¼Œå½¢çŠ¶ `[num_envs]`
  - True (1)ï¼šç¯å¢ƒå¤±è´¥éœ€è¦é‡ç½®
  - False (0)ï¼šç¯å¢ƒç»§ç»­è¿è¡Œ
- `self.time_out_buf`ï¼šå¸ƒå°”å¼ é‡ï¼Œæ ‡è®°å“ªäº›ç¯å¢ƒå› è¶…æ—¶è€Œç»“æŸ
  - True (1)ï¼šå› è¾¾åˆ°æœ€å¤§episodeé•¿åº¦è€Œç»“æŸï¼ˆæ­£å¸¸ï¼‰
  - False (0)ï¼šæœªè¶…æ—¶
- `~self.time_out_buf`ï¼šé€»è¾‘éï¼Œåè½¬è¶…æ—¶æ ‡è®°
  - True (1)ï¼šéè¶…æ—¶ç»“æŸ
  - False (0)ï¼šè¶…æ—¶ç»“æŸ
- `reset_buf * ~time_out_buf`ï¼šé€»è¾‘ä¸æ“ä½œ
  - ç»“æœä¸º 1ï¼šç¯å¢ƒé‡ç½®ä¸”éè¶…æ—¶ï¼ˆå³å¤±è´¥ï¼Œå¦‚æ‘”å€’ï¼‰
  - ç»“æœä¸º 0ï¼šç¯å¢ƒæœªé‡ç½®æˆ–æ­£å¸¸è¶…æ—¶

**é€»è¾‘è¡¨ï¼š**
```
reset_buf | time_out_buf | ~time_out_buf | ç»“æœ | å«ä¹‰
    0     |      0       |       1       |  0   | ç»§ç»­è¿è¡Œ
    0     |      1       |       0       |  0   | ç»§ç»­è¿è¡Œï¼ˆä¸ä¼šåŒæ—¶ä¸ºTrueï¼‰
    1     |      0       |       1       |  1   | å¤±è´¥ç»ˆæ­¢ï¼ˆæƒ©ç½šï¼‰
    1     |      1       |       0       |  0   | æ­£å¸¸è¶…æ—¶ï¼ˆä¸æƒ©ç½šï¼‰
```

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`-0.0` (é€šå¸¸ç¦ç”¨)
- é€‚ç”¨åœºæ™¯ï¼šéœ€è¦æ˜ç¡®æƒ©ç½šå¤±è´¥çš„è®­ç»ƒæ—©æœŸ

---

### 16. dof_pos_limits - å…³èŠ‚ä½ç½®é™åˆ¶æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1183-1187 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_dof_pos_limits(self):
    # Penalize dof positions too close to the limit
    out_of_limits = -(self.dof_pos - self.dof_pos_limits[:, 0]).clip(max=0.) # lower limit
    out_of_limits += (self.dof_pos - self.dof_pos_limits[:, 1]).clip(min=0.)
    return torch.sum(out_of_limits, dim=1)
```

#### é€è¡Œè§£é‡Š

```python
out_of_limits = -(self.dof_pos - self.dof_pos_limits[:, 0]).clip(max=0.)
```
- `self.dof_pos`ï¼šå½“å‰å…³èŠ‚ä½ç½®ï¼Œå½¢çŠ¶ `[num_envs, num_dof]`
- `self.dof_pos_limits[:, 0]`ï¼šå…³èŠ‚ä½ç½®ä¸‹é™ï¼Œå½¢çŠ¶ `[num_dof]`
- `dof_pos - dof_pos_limits[:, 0]`ï¼šè®¡ç®—ä¸ä¸‹é™çš„å·®å€¼
  - æ­£å€¼ï¼šåœ¨é™åˆ¶èŒƒå›´å†…
  - è´Ÿå€¼ï¼šè¶…å‡ºä¸‹é™
- `.clip(max=0.)`ï¼šè£å‰ªï¼Œä¿ç•™è´Ÿå€¼ï¼ˆè¶…é™éƒ¨åˆ†ï¼‰ï¼Œæ­£å€¼å˜ä¸º 0
- `-(...)`: å–è´Ÿï¼Œå°†è´Ÿå€¼å˜ä¸ºæ­£çš„æƒ©ç½šå€¼
- **ç»“æœï¼š** è¶…å‡ºä¸‹é™è¶Šå¤šï¼Œæƒ©ç½šè¶Šå¤§

```python
out_of_limits += (self.dof_pos - self.dof_pos_limits[:, 1]).clip(min=0.)
```
- `self.dof_pos_limits[:, 1]`ï¼šå…³èŠ‚ä½ç½®ä¸Šé™
- `dof_pos - dof_pos_limits[:, 1]`ï¼šè®¡ç®—ä¸ä¸Šé™çš„å·®å€¼
  - æ­£å€¼ï¼šè¶…å‡ºä¸Šé™
  - è´Ÿå€¼ï¼šåœ¨é™åˆ¶èŒƒå›´å†…
- `.clip(min=0.)`ï¼šè£å‰ªï¼Œä¿ç•™æ­£å€¼ï¼ˆè¶…é™éƒ¨åˆ†ï¼‰ï¼Œè´Ÿå€¼å˜ä¸º 0
- ç´¯åŠ åˆ° `out_of_limits`

```python
return torch.sum(out_of_limits, dim=1)
```
- å¯¹æ‰€æœ‰å…³èŠ‚æ±‚å’Œï¼Œå¾—åˆ°æ€»æƒ©ç½š

**ä½ç½®é™åˆ¶ç¤ºä¾‹ï¼š**
```
å…³èŠ‚é™åˆ¶: [-1.0, 1.0] rad
å½“å‰ä½ç½®: -1.2 rad â†’ è¶…å‡ºä¸‹é™ 0.2 â†’ æƒ©ç½š = 0.2
å½“å‰ä½ç½®: 1.1 rad  â†’ è¶…å‡ºä¸Šé™ 0.1 â†’ æƒ©ç½š = 0.1
å½“å‰ä½ç½®: 0.5 rad  â†’ åœ¨èŒƒå›´å†…      â†’ æƒ©ç½š = 0
```

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`0.0` (Aliengo ç¦ç”¨)
- `soft_dof_pos_limit`: 0.95 (ä½¿ç”¨ 95% çš„ URDF é™åˆ¶)
- é€‚ç”¨åœºæ™¯ï¼šé˜²æ­¢æœºå™¨äººè¿›å…¥å¥‡å¼‚ä½å½¢

---

### 17. dof_vel_limits - å…³èŠ‚é€Ÿåº¦é™åˆ¶æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1189-1192 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_dof_vel_limits(self):
    # Penalize dof velocities too close to the limit
    # clip to max error = 1 rad/s per joint to avoid huge penalties
    return torch.sum((torch.abs(self.dof_vel) - self.dof_vel_limits*self.cfg.rewards.soft_dof_vel_limit).clip(min=0., max=1.), dim=1)
```

#### é€è¡Œè§£é‡Š

```python
return torch.sum((torch.abs(self.dof_vel) - self.dof_vel_limits*self.cfg.rewards.soft_dof_vel_limit).clip(min=0., max=1.), dim=1)
```
- `self.dof_vel`ï¼šå½“å‰å…³èŠ‚é€Ÿåº¦ï¼Œå½¢çŠ¶ `[num_envs, num_dof]`
- `torch.abs(self.dof_vel)`ï¼šé€Ÿåº¦çš„ç»å¯¹å€¼ï¼ˆé€Ÿåº¦å¯æ­£å¯è´Ÿï¼‰
- `self.dof_vel_limits`ï¼šå…³èŠ‚é€Ÿåº¦é™åˆ¶ï¼ˆæ­£å€¼ï¼‰ï¼Œå½¢çŠ¶ `[num_dof]`
- `soft_dof_vel_limit`ï¼šè½¯é™åˆ¶ç³»æ•°ï¼ˆé»˜è®¤ 0.95ï¼‰
- `dof_vel_limits * soft_dof_vel_limit`ï¼šå®é™…ä½¿ç”¨çš„é™åˆ¶ï¼ˆ95% çš„ç¡¬é™åˆ¶ï¼‰
- `abs(dof_vel) - soft_limit`ï¼šè®¡ç®—è¶…å‡ºè½¯é™åˆ¶çš„éƒ¨åˆ†
  - æ­£å€¼ï¼šè¶…é™
  - è´Ÿå€¼ï¼šæœªè¶…é™
- `.clip(min=0., max=1.)`ï¼š
  - `min=0.`ï¼šç§»é™¤è´Ÿå€¼ï¼ˆæœªè¶…é™çš„æƒ…å†µï¼‰
  - `max=1.`ï¼šé™åˆ¶æœ€å¤§è¯¯å·®ä¸º 1 rad/sï¼Œé¿å…è¿‡å¤§æƒ©ç½š
- `torch.sum(..., dim=1)`ï¼šå¯¹æ‰€æœ‰å…³èŠ‚æ±‚å’Œ

**é€Ÿåº¦é™åˆ¶ç¤ºä¾‹ï¼š**
```
ç¡¬é™åˆ¶: 10 rad/s
è½¯é™åˆ¶: 10 Ã— 0.95 = 9.5 rad/s
å½“å‰é€Ÿåº¦: 8 rad/s   â†’ æœªè¶…é™        â†’ æƒ©ç½š = 0
å½“å‰é€Ÿåº¦: 9.7 rad/s â†’ è¶…é™ 0.2     â†’ æƒ©ç½š = 0.2
å½“å‰é€Ÿåº¦: 12 rad/s  â†’ è¶…é™ 2.5     â†’ æƒ©ç½š = 1.0 (è£å‰ª)
```

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`0.0` (Aliengo ç¦ç”¨)
- `soft_dof_vel_limit`: 0.95
- æœ€å¤§å•å…³èŠ‚æƒ©ç½šï¼š1.0
- é€‚ç”¨åœºæ™¯ï¼šé˜²æ­¢ç”µæœºè¿‡é€Ÿè¿è½¬

---

### 18. torque_limits - åŠ›çŸ©é™åˆ¶æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1194-1196 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_torque_limits(self):
    # penalize torques too close to the limit
    return torch.sum((torch.abs(self.torques) - self.torque_limits*self.cfg.rewards.soft_torque_limit).clip(min=0.), dim=1)
```

#### é€è¡Œè§£é‡Š

```python
return torch.sum((torch.abs(self.torques) - self.torque_limits*self.cfg.rewards.soft_torque_limit).clip(min=0.), dim=1)
```
- `self.torques`ï¼šå½“å‰å…³èŠ‚åŠ›çŸ©ï¼Œå½¢çŠ¶ `[num_envs, num_dof]`
- `torch.abs(self.torques)`ï¼šåŠ›çŸ©çš„ç»å¯¹å€¼
- `self.torque_limits`ï¼šå…³èŠ‚åŠ›çŸ©é™åˆ¶ï¼Œå½¢çŠ¶ `[num_dof]`
- `soft_torque_limit`ï¼šè½¯é™åˆ¶ç³»æ•°ï¼ˆé»˜è®¤ 0.95ï¼‰
- è®¡ç®—è¶…å‡ºè½¯é™åˆ¶çš„éƒ¨åˆ†å¹¶è£å‰ªè´Ÿå€¼
- ä¸ `dof_vel_limits` ç±»ä¼¼ï¼Œä½†æ²¡æœ‰æœ€å¤§è¯¯å·®é™åˆ¶

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`0.0` (Aliengo ç¦ç”¨)
- `soft_torque_limit`: 0.95
- é€‚ç”¨åœºæ™¯ï¼šé˜²æ­¢ç”µæœºè¿‡è½½å’ŒæŸå

---

### 19. feet_air_time - è¶³ç«¯æ»ç©ºæ—¶é—´å¥–åŠ±

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1198-1209 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_feet_air_time(self):
    # Reward long steps
    # Need to filter the contacts because the contact reporting of PhysX is unreliable on meshes
    contact = self.contact_forces[:, self.feet_indices, 2] > 1.
    contact_filt = torch.logical_or(contact, self.last_contacts) 
    self.last_contacts = contact
    first_contact = (self.feet_air_time > 0.) * contact_filt
    self.feet_air_time += self.dt
    rew_airTime = torch.sum((self.feet_air_time - 0.5) * first_contact, dim=1) # reward only on first contact with the ground
    rew_airTime *= torch.norm(self.commands[:, :2], dim=1) > 0.1 #no reward for zero command
    self.feet_air_time *= ~contact_filt
    return rew_airTime
```

#### é€è¡Œè§£é‡Š

```python
contact = self.contact_forces[:, self.feet_indices, 2] > 1.
```
- `self.contact_forces[:, self.feet_indices, 2]`ï¼šè¶³ç«¯çš„ z è½´ï¼ˆå‚ç›´ï¼‰æ¥è§¦åŠ›
- `> 1.`ï¼šåˆ¤æ–­å‚ç›´æ¥è§¦åŠ›æ˜¯å¦å¤§äº 1 N
- ç»“æœï¼šå¸ƒå°”å¼ é‡ï¼Œå½¢çŠ¶ `[num_envs, num_feet]`ï¼ŒTrue è¡¨ç¤ºè¶³ç«¯æ¥è§¦åœ°é¢

```python
contact_filt = torch.logical_or(contact, self.last_contacts)
self.last_contacts = contact
```
- æ¥è§¦åŠ›æ»¤æ³¢ï¼šå½“å‰æ¥è§¦æˆ–ä¸Šä¸€å¸§æ¥è§¦éƒ½ç®—ä½œæ¥è§¦
- **åŸå› ï¼š** PhysX åœ¨ç½‘æ ¼åœ°å½¢ä¸Šçš„æ¥è§¦æ£€æµ‹ä¸å¯é ï¼Œéœ€è¦æ—¶é—´å¹³æ»‘
- æ›´æ–° `last_contacts` ç”¨äºä¸‹ä¸€å¸§

```python
first_contact = (self.feet_air_time > 0.) * contact_filt
```
- `self.feet_air_time > 0.`ï¼šè¶³ç«¯ä¹‹å‰åœ¨ç©ºä¸­ï¼ˆæ»ç©ºæ—¶é—´ > 0ï¼‰
- `* contact_filt`ï¼šä¸”å½“å‰æ¥è§¦åœ°é¢
- **ç»“æœï¼š** æ ‡è®°é¦–æ¬¡æ¥è§¦åœ°é¢çš„æ—¶åˆ»

```python
self.feet_air_time += self.dt
```
- æ‰€æœ‰è¶³ç«¯çš„æ»ç©ºæ—¶é—´å¢åŠ ä¸€ä¸ªæ—¶é—´æ­¥ï¼ˆ0.005 ç§’ï¼‰

```python
rew_airTime = torch.sum((self.feet_air_time - 0.5) * first_contact, dim=1)
```
- `(self.feet_air_time - 0.5)`ï¼šæ»ç©ºæ—¶é—´å‡å» 0.5 ç§’
  - æ»ç©º < 0.5 ç§’ï¼šè´Ÿå¥–åŠ±ï¼ˆæ­¥æ€è¿‡å¿«ï¼‰
  - æ»ç©º > 0.5 ç§’ï¼šæ­£å¥–åŠ±ï¼ˆæ­¥æ€æ­£å¸¸ï¼‰
- `* first_contact`ï¼šä»…åœ¨é¦–æ¬¡æ¥è§¦æ—¶è®¡ç®—å¥–åŠ±
- `torch.sum(..., dim=1)`ï¼šå¯¹æ‰€æœ‰è¶³ç«¯æ±‚å’Œ

```python
rew_airTime *= torch.norm(self.commands[:, :2], dim=1) > 0.1
```
- `torch.norm(self.commands[:, :2], dim=1)`ï¼šé€Ÿåº¦å‘½ä»¤çš„å¤§å°
- `> 0.1`ï¼šä»…åœ¨é€Ÿåº¦å‘½ä»¤ > 0.1 m/s æ—¶ç»™äºˆå¥–åŠ±
- **åŸå› ï¼š** é™æ­¢æ—¶ä¸åº”è¯¥å¥–åŠ±æ»ç©ºæ—¶é—´

```python
self.feet_air_time *= ~contact_filt
```
- `~contact_filt`ï¼šé€»è¾‘éï¼Œæ ‡è®°æœªæ¥è§¦çš„è¶³ç«¯
- å°†æ¥è§¦åœ°é¢çš„è¶³ç«¯æ»ç©ºæ—¶é—´é‡ç½®ä¸º 0
- æœªæ¥è§¦çš„è¶³ç«¯ä¿æŒç´¯è®¡æ»ç©ºæ—¶é—´

```python
return rew_airTime
```
- è¿”å›æ€»å¥–åŠ±

**æ­¥æ€å‘¨æœŸç¤ºä¾‹ï¼š**
```
æ—¶é—´è½´:
è¶³ç«¯ç¦»åœ° â”€â”€â” æ»ç©º 0.4s â”Œâ”€â”€ ç€åœ°
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ»ç©ºæ—¶é—´ç´¯è®¡: 0 â†’ 0.4s
é¦–æ¬¡æ¥è§¦: å¥–åŠ± = (0.4 - 0.5) = -0.1 (æ­¥å¤ªå¿«)

è¶³ç«¯ç¦»åœ° â”€â”€â” æ»ç©º 0.7s â”Œâ”€â”€ ç€åœ°
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é¦–æ¬¡æ¥è§¦: å¥–åŠ± = (0.7 - 0.5) = +0.2 (æ­£å¸¸æ­¥æ€)
```

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`1.0` (åŸºç¡€) / `0.0` (Aliengo ç¦ç”¨)
- ç›®æ ‡æ»ç©ºæ—¶é—´ï¼š> 0.5 ç§’
- é€‚ç”¨åœºæ™¯ï¼šé¼“åŠ±æ­£å¸¸æ­¥æ€çš„ä»»åŠ¡

---

### 20. feet_stumble - è¶³ç«¯ç»Šå€’æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1211-1214 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_stumble(self):
    # Penalize feet hitting vertical surfaces
    return torch.any(torch.norm(self.contact_forces[:, self.feet_indices, :2], dim=2) >\
         5 *torch.abs(self.contact_forces[:, self.feet_indices, 2]), dim=1)
```

#### é€è¡Œè§£é‡Š

```python
return torch.any(torch.norm(self.contact_forces[:, self.feet_indices, :2], dim=2) > 5 * torch.abs(self.contact_forces[:, self.feet_indices, 2]), dim=1)
```
- `self.contact_forces[:, self.feet_indices, :2]`ï¼šè¶³ç«¯çš„æ°´å¹³æ¥è§¦åŠ› (x, y)
- `torch.norm(..., dim=2)`ï¼šæ°´å¹³æ¥è§¦åŠ›çš„æ¨¡ï¼Œå½¢çŠ¶ `[num_envs, num_feet]`
- `self.contact_forces[:, self.feet_indices, 2]`ï¼šè¶³ç«¯çš„å‚ç›´æ¥è§¦åŠ› (z)
- `torch.abs(...)`ï¼šå‚ç›´æ¥è§¦åŠ›çš„ç»å¯¹å€¼
- `5 * ...`ï¼šå‚ç›´åŠ›çš„ 5 å€
- æ¯”è¾ƒï¼šæ°´å¹³åŠ› > 5 Ã— å‚ç›´åŠ›ï¼Ÿ
  - Trueï¼šå¯èƒ½è¸¢åˆ°éšœç¢ç‰©ï¼ˆç»Šå€’ï¼‰
  - Falseï¼šæ­£å¸¸ç€åœ°
- `torch.any(..., dim=1)`ï¼šä»»æ„ä¸€åªè„šç»Šå€’éƒ½ç®—
  - True (1)ï¼šå‘ç”Ÿç»Šå€’
  - False (0)ï¼šæ— ç»Šå€’

**ç»Šå€’åˆ¤æ–­é€»è¾‘ï¼š**
```
æ­£å¸¸ç€åœ°:
  æ°´å¹³åŠ› = 2 N, å‚ç›´åŠ› = 10 N
  2 < 5Ã—10 â†’ ä¸ç®—ç»Šå€’

è¸¢åˆ°éšœç¢ç‰©:
  æ°´å¹³åŠ› = 60 N, å‚ç›´åŠ› = 8 N
  60 > 5Ã—8 â†’ ç®—ç»Šå€’ï¼Œæƒ©ç½š = 1
```

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`-0.0` (é€šå¸¸ç¦ç”¨)
- æ°´å¹³/å‚ç›´åŠ›æ¯”ä¾‹é˜ˆå€¼ï¼š5
- é€‚ç”¨åœºæ™¯ï¼šå¤æ‚åœ°å½¢å¯¼èˆª

---

### 21. stand_still - é™æ­¢æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1216-1218 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_stand_still(self):
    # Penalize motion at zero commands
    return torch.sum(torch.abs(self.dof_pos - self.default_dof_pos), dim=1) * (torch.norm(self.commands[:, :2], dim=1) < 0.1)
```

#### é€è¡Œè§£é‡Š

```python
return torch.sum(torch.abs(self.dof_pos - self.default_dof_pos), dim=1) * (torch.norm(self.commands[:, :2], dim=1) < 0.1)
```
- `self.dof_pos`ï¼šå½“å‰å…³èŠ‚ä½ç½®
- `self.default_dof_pos`ï¼šé»˜è®¤å…³èŠ‚ä½ç½®ï¼ˆç«™ç«‹å§¿æ€ï¼‰
- `torch.abs(...)`ï¼šè®¡ç®—æ¯ä¸ªå…³èŠ‚åç¦»é»˜è®¤ä½ç½®çš„ç»å¯¹å€¼
- `torch.sum(..., dim=1)`ï¼šå¯¹æ‰€æœ‰å…³èŠ‚æ±‚å’Œï¼Œå¾—åˆ°æ€»åå·®
- `torch.norm(self.commands[:, :2], dim=1)`ï¼šé€Ÿåº¦å‘½ä»¤çš„å¤§å°
- `< 0.1`ï¼šé€Ÿåº¦å‘½ä»¤æ¥è¿‘é›¶ï¼ˆé™æ­¢å‘½ä»¤ï¼‰
- `*`ï¼šä»…åœ¨é™æ­¢å‘½ä»¤æ—¶æƒ©ç½šå…³èŠ‚åç¦»

**é€»è¾‘ï¼š**
```
é€Ÿåº¦å‘½ä»¤ > 0.1 m/s: å…è®¸å…³èŠ‚è¿åŠ¨ï¼Œä¸æƒ©ç½š
é€Ÿåº¦å‘½ä»¤ < 0.1 m/s: æœŸæœ›é™æ­¢ï¼Œæƒ©ç½šå…³èŠ‚åç¦»é»˜è®¤å§¿æ€
```

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼š`-0.0` (é€šå¸¸ç¦ç”¨)
- é€Ÿåº¦é˜ˆå€¼ï¼š0.1 m/s
- é€‚ç”¨åœºæ™¯ï¼šéœ€è¦é™æ€ç«™ç«‹çš„åœºæ™¯

---

### 22. feet_contact_forces - è¶³ç«¯æ¥è§¦åŠ›æƒ©ç½š

**ä»£ç ä½ç½®ï¼š** ç¬¬ 1220-1223 è¡Œ

#### å®Œæ•´æºä»£ç 

```python
def _reward_feet_contact_forces(self):
    # penalize high contact forces
    return torch.sum((torch.norm(self.contact_forces[:, self.feet_indices, :], dim=-1) -  self.cfg.rewards.max_contact_force).clip(min=0.), dim=1)
```

#### é€è¡Œè§£é‡Š

```python
return torch.sum((torch.norm(self.contact_forces[:, self.feet_indices, :], dim=-1) - self.cfg.rewards.max_contact_force).clip(min=0.), dim=1)
```
- `self.contact_forces[:, self.feet_indices, :]`ï¼šè¶³ç«¯ä¸‰è½´æ¥è§¦åŠ›ï¼Œå½¢çŠ¶ `[num_envs, num_feet, 3]`
- `torch.norm(..., dim=-1)`ï¼šè®¡ç®—æ¥è§¦åŠ›çš„æ¨¡ï¼ˆåˆåŠ›å¤§å°ï¼‰ï¼Œå½¢çŠ¶ `[num_envs, num_feet]`
- `- max_contact_force`ï¼šå‡å»æœ€å¤§å…è®¸æ¥è§¦åŠ›ï¼ˆ100 Nï¼‰
  - æ­£å€¼ï¼šè¶…å‡ºé™åˆ¶
  - è´Ÿå€¼ï¼šåœ¨é™åˆ¶å†…
- `.clip(min=0.)`ï¼šè£å‰ªè´Ÿå€¼ï¼Œä»…ä¿ç•™è¶…é™éƒ¨åˆ†
- `torch.sum(..., dim=1)`ï¼šå¯¹æ‰€æœ‰è¶³ç«¯æ±‚å’Œ

**æ¥è§¦åŠ›ç¤ºä¾‹ï¼š**
```
æœ€å¤§å…è®¸åŠ›: 100 N
è¶³ç«¯1: æ¥è§¦åŠ› = 80 N  â†’ æœªè¶…é™ â†’ æƒ©ç½š = 0
è¶³ç«¯2: æ¥è§¦åŠ› = 120 N â†’ è¶…é™ 20 N â†’ æƒ©ç½š = 20
è¶³ç«¯3: æ¥è§¦åŠ› = 150 N â†’ è¶…é™ 50 N â†’ æƒ©ç½š = 50
æ€»æƒ©ç½š: 0 + 20 + 50 = 70
```

**é…ç½®å‚æ•°ï¼š**
- æƒé‡ï¼šæœªåœ¨é…ç½®ä¸­æ˜¾å¼åˆ—å‡º
- `max_contact_force`: 100 N
- é€‚ç”¨åœºæ™¯ï¼šé˜²æ­¢ç€åœ°å†²å‡»è¿‡å¤§ï¼Œé¼“åŠ±æŸ”å’Œç€åœ°

---

## é…ç½®å‚æ•°è¯´æ˜

---

## é™„å½•

### A. æ•°å­¦å…¬å¼æ±‡æ€»

#### æ€»å¥–åŠ±å‡½æ•°
$$R_{total}(s, a) = \sum_{i=1}^{N} w_i \cdot r_i(s, a) \cdot \Delta t$$

#### é«˜æ–¯å¥–åŠ±å‡½æ•°
$$r_{gaussian}(e) = \exp\left(-\frac{e}{\sigma}\right)$$

åº”ç”¨äºé€Ÿåº¦è·Ÿè¸ªï¼štracking_lin_vel, tracking_ang_vel

#### äºŒæ¬¡æƒ©ç½šå‡½æ•°
$$r_{quadratic} = -\sum_i (x_i - x_i^{target})^2$$

#### åŠŸç‡è®¡ç®—
$$P = \sum_{i=1}^{n_{dof}} |\omega_i| \cdot |\tau_i|$$

#### äºŒé˜¶å·®åˆ†ï¼ˆå¹³æ»‘åº¦ï¼‰
$$\Delta^2 a_t = a_t - 2a_{t-1} + a_{t-2}$$

---

### B. å¿«é€Ÿå‚è€ƒè¡¨

| å¥–åŠ±é¡¹ | é»˜è®¤æƒé‡ | ç±»å‹ | ä¸»è¦ä½œç”¨ |
|-------|---------|------|---------|
| tracking_lin_vel | +1.0 | æ­£å¥–åŠ± | é€Ÿåº¦è·Ÿè¸ª |
| tracking_ang_vel | +0.5 | æ­£å¥–åŠ± | è§’é€Ÿåº¦è·Ÿè¸ª |
| lin_vel_z | -2.0 | æƒ©ç½š | æŠ‘åˆ¶å‚ç›´é€Ÿåº¦ |
| orientation | -0.2 | æƒ©ç½š | ä¿æŒæ°´å¹³å§¿æ€ |
| base_height | -1.0 | æƒ©ç½š | ä¿æŒç›®æ ‡é«˜åº¦ |
| action_rate | -0.01 | æƒ©ç½š | åŠ¨ä½œå¹³æ»‘ |
| smoothness | -0.01 | æƒ©ç½š | äºŒé˜¶å¹³æ»‘ |
| joint_power | -2e-5 | æƒ©ç½š | èƒ½æ•ˆä¼˜åŒ– |

---

## æ€»ç»“

HIMLoco çš„å¥–åŠ±å‡½æ•°è®¾è®¡æ˜¯ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„å¤šç›®æ ‡ä¼˜åŒ–ç³»ç»Ÿï¼Œé€šè¿‡ 22 ä¸ªå¯é…ç½®çš„å¥–åŠ±é¡¹å®ç°äº†ï¼š

âœ… **æ€§èƒ½é©±åŠ¨** - å‡†ç¡®è·Ÿè¸ªé€Ÿåº¦å‘½ä»¤  
âœ… **ç¨³å®šä¿è¯** - ä¿æŒèº«ä½“å§¿æ€å’Œé«˜åº¦  
âœ… **è¿åŠ¨è´¨é‡** - å¹³æ»‘ã€è‡ªç„¶çš„æ­¥æ€  
âœ… **èƒ½æ•ˆä¼˜åŒ–** - é™ä½åŠŸç‡æ¶ˆè€—  
âœ… **å®‰å…¨çº¦æŸ** - é¿å…ç¢°æ’å’Œè¶…é™  

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š
- ç†è§£æ¯ä¸ªå¥–åŠ±å‡½æ•°çš„ä½œç”¨å’Œå®ç°
- æ ¹æ®ä»»åŠ¡éœ€æ±‚è°ƒæ•´å¥–åŠ±æƒé‡
- è¯Šæ–­å’Œè§£å†³è®­ç»ƒä¸­çš„é—®é¢˜
- ä¼˜åŒ–æœºå™¨äººçš„è¿åŠ¨æ€§èƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 2.0  
**æœ€åæ›´æ–°ï¼š** 2025-10-24  
**ä½œè€…ï¼š** GitHub Copilot  
**é¡¹ç›®ï¼š** HIMLoco - Hâˆ Locomotion Control

ğŸ“– **å®Œæ•´æ–‡æ¡£é•¿åº¦ï¼š** çº¦ 15,000 å­—  
ğŸ¯ **è¦†ç›–å†…å®¹ï¼š** 22 ä¸ªå¥–åŠ±å‡½æ•° + å®Œæ•´ä»£ç è§£æ  
ï¿½ï¿½ **å®ç”¨å·¥å…·ï¼š** è°ƒè¯•æ¸…å• + ä¼˜åŒ–æŒ‡å— + ä»£ç ç¤ºä¾‹
